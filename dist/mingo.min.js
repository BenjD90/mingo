!function(n,t){"use strict";function r(n,t,r){r=r||{},r.root=r.root||s(n);var e=b(n,t,null,r);return qn.includes(e)?En[e](n,t,r):e}function e(n,t){return n[t]}function u(n,t,r){for(var i=t.split("."),o=n,a=0;a<i.length;a++){var l=N(i[a].match(/^\d+$/));if(l&&M(o)){if(r===!0&&0===a)return o;o=o.map(function(n){return u(n,i[a],!0)}),1===o.length&&(o=o[0])}else o=e(o,i[a]),r=!1;if(Q(o))break}return o}function i(n,r){if(!Q(n)){var u,o=r.split("."),a=o[0],l=1===o.length||o.slice(1).join("."),s=null!==a.match(/^\d+$/);try{if(1===o.length)if(M(n))s?(u=e(n,a),_(u),u=[u]):(u=[],G(n,function(n){var t=i(n,r);Q(t)||u.push(t)}),O(u.length>0));else{var c=e(n,a);_(c),u={},u[a]=c}else if(M(n))s?(u=e(n,a),u=i(u,l),_(u),u=[u]):(u=[],G(n,function(n){var t=i(n,r);Q(t)||u.push(t)}),O(u.length>0));else{var c=e(n,a);c=i(c,l),_(c),u={},u[a]=c}}catch(f){u=t}return u}}function o(n,t,r,e){var u=t.split("."),i=u[0],a=1===u.length||u.slice(1).join("."),l=/^\d+$/.test(i);if(1===u.length)r(n,i);else if(M(n)&&!l)G(n,function(n){o(n,t,r,e)});else{if(e===!0){var s=Y(n,i);s&&!D(n[i])||(n[i]={})}o(n[i],a,r,e)}}function a(n,t,r){o(n,t,function(n,t){n[t]=r})}function l(n,t){o(n,t,function(n,t){M(n)&&/^\d+$/.test(t)?n.splice(parseInt(t),1):I(n)&&delete n[t]})}function s(n){switch(T(n)){case"array":return n.map(s);case"object":return H(n,s);default:return n}}function c(n){for(var t=0;t<Un.length;t++)if(Un[t](n))return!0;return!1}function f(n){return c(n)||!E(n)}function h(n){if(f(n))return q(n)?{$regex:n}:{$eq:n};if(E(n)){var t=J(n),r=0===K(d(Cn),t).length;if(r)return{$eq:n};if(t.includes("$regex")){var e=n.$regex,u=n.$options||"",i="";k(e)&&(i+=e.ignoreCase||u.indexOf("i")>=0?"i":"",i+=e.multiline||u.indexOf("m")>=0?"m":"",i+=e.global||u.indexOf("g")>=0?"g":"",e=new RegExp(e,i)),n.$regex=e,delete n.$options}}return n}function p(n,t){return new Array(Math.max(t-String(n).length+1,0)).join("0")+n}function d(n){return J(Rn[n])}function v(n,t,r){for(var e,u,i,o={},a=[],l=n.length,c=0;l>c;c++)u=n[c],e=t.call(r,u,c),i=y(u),Y(o,i)||(o[i]=[e,c]),a.push(s(u));return a.sort(function(n,t){var r=o[y(n)],e=o[y(t)];return r[0]<e[0]?-1:r[0]>e[0]?1:r[1]<e[1]?-1:r[1]>e[1]?1:0}),O(a.length===n.length,"sortBy must retain collection length"),a}function g(n,t,r){var e={keys:[],groups:[]},u={};return G(n,function(n){var i=t.call(r,n),o=y(i),a=-1;Q(u[o])&&(a=e.keys.length,u[o]=a,e.keys.push(i),e.groups.push([])),a=u[o],e.groups[a].push(n)}),O(e.keys.length===e.groups.length,"Cardinality must be equal for groups and keys"),e}function $(n){return ln({"":n})+T(n)+n}function y(n){var t,r,e,u=0,i=$(n);if(0===i.length)return u;for(t=0,e=i.length;e>t;t++)r=i.charCodeAt(t),u=(u<<5)-u+r,u|=0;return u.toString()}function m(n,r,e){if(d(Nn).includes(r))return $n[r](n,e);if(I(e)){var u={};for(var i in e)if(Y(e,i)&&(u[i]=m(n,i,e[i]),d(Nn).includes(i))){u=u[i],J(e).length>1&&z("Invalid $group expression '"+ln(e)+"'");break}return u}return t}function b(n,t,r,e){if(e=e||{},e.root=e.root||s(n),d(Qn).includes(r))return Mn[r](n,t,e);if(d(Nn).includes(r))return n=b(n,t,null,e),O(M(n),"Must use collection type with "+r+" operator"),$n[r](n,null,e);if(k(t)&&t.length>0&&"$"===t[0]){if(Sn.includes(t))return In[t](n,null,e);if(qn.includes(t))return t;var i=Sn.filter(function(n){return 0===t.indexOf(n+".")});return 1===i.length&&(i=i[0],"$$ROOT"===i&&(n=e.root),t=t.substr(i.length)),u(n,t.slice(1))}switch(T(t)){case"array":return t.map(function(t){return b(n,t,null)});case"object":var o={};for(var a in t)if(Y(t,a)&&(o[a]=b(n,t[a],a,e),d(Qn).includes(a))){O(1===J(t).length,"Invalid aggregation expression '"+ln(t)+"'"),o=o[a];break}return o;default:return s(t)}}function O(n,t){U(n)&&z(t)}function _(n){return O(!Q(n))}function x(n,t){O(n===Object(n),t)}function j(n,t){return T(n)===t}function w(n){return j(n,"boolean")}function k(n){return j(n,"string")}function A(n){return j(n,"number")}function M(n){return j(n,"array")}function I(n){return j(n,"object")}function E(n){return n===Object(n)}function S(n){return j(n,"date")}function q(n,t){return j(n,"regexp")}function C(n,t){return j(n,"function")}function N(n){return j(n,"null")}function Q(n){return j(n,"undefined")}function D(n){return N(n)||Q(n)}function P(n,t){return!n.includes(t)}function R(n,t){return n.includes(t)}function L(n){return!!n}function U(n){return!n}function F(n){return D(n)||M(n)&&0===n.length||I(n)&&0===J(n).length||!n}function B(n){return M(n)?n:[n]}function T(n){return Object.prototype.toString.call(n).match(/\s(\w+)/)[1].toLowerCase()}function Y(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function z(n){throw new Error(n)}function J(n){return Object.keys(n)}function G(n,t,r){if(x(n,"Cannot iterate over object of type '"+T(n)+"'"),M(n))n.forEach(t,r);else for(var e in n)Y(n,e)&&t.call(r,n[e],e)}function H(n,t,r){if(M(n))return n.map(t,r);if(I(n)){for(var e,u={},i=J(n),o=0,a=i.length;a>o;o++)e=i[o],u[e]=t.call(r,n[e],e);return u}z("Input must be an Array or Object type")}function K(n,t){return n.filter(R.bind(null,t))}function V(n,t){var r=[];return on.apply(r,n),on.apply(r,t.filter(P.bind(null,n))),r}function W(n,t){O(M(n),"Input must be an Array");var r=[],e=function(n,t){for(var u=0,i=n.length;i>u;u++)M(n[u])&&(t>0||0>t)?e(n[u],Math.max(-1,t-1)):on.call(r,n[u])};return e(n,t||-1),r}function X(n,t){if(n===t)return!0;var r=T(n);if(r!==T(t))return!1;if("number"===r&&isNaN(n)&&isNaN(t))return!0;if(["date","regexp"].includes(r))return n.toString()===t.toString();if("array"===r){if(n.length===t.length&&0===n.length)return!0;if(n.length!==t.length)return!1;for(var e=0,u=n.length;u>e;e++)if(!X(n[e],t[e]))return!1}else{if(![n,t].every(I))return!1;var i=J(n),o=J(t);if(i.length!==o.length)return!1;if(i.sort(),o.sort(),!X(i,o))return!1;for(var e=0,a=i.length;a>e;e++){var r=i[e];if(!X(n[r],t[r]))return!1}}return!0}function Z(n){var t={},r=[];return G(n,function(n){var e=y(n);Y(t,e)||(r.push(n),t[e]=0)}),r}function nn(n){var t=n.dataset.reduce(function(n,t){return n+t},0),r=n.dataset.length||1,e=n.sampled===!0?1:0,u=t/(r-e);return Math.sqrt(n.dataset.reduce(function(n,t){return n+Math.pow(t-u,2)},0)/r)}function tn(n,t,r){return D(r)?0>t?(t=Math.max(0,n.length+t),r=n.length-t+1):(r=t,t=0):(0>t&&(t=Math.max(0,n.length+t)),O(r>0,"Invalid argument value for $slice operator. Limit must be a positive number"),r+=t),an.apply(n,[t,r])}var rn,en={};en.VERSION="0.9.2",null!==n&&(rn=n.Mingo),en.noConflict=function(){return n.Mingo=rn,en};var un=t!==module&&"undefined"!=typeof require;un?module!==t&&(module.exports=en):n.Mingo=en;var on=Array.prototype.push,an=Array.prototype.slice,ln=JSON.stringify;!function(){Function.prototype.bind||(Function.prototype.bind=function(n){"function"!=typeof this&&z("Function.prototype.bind - what is trying to be bound is not callable");var t=an.call(arguments,1),r=this,e=function(){},u=function(){return r.apply(this instanceof e?this:n,t.concat(an.call(arguments)))};return this.prototype&&(e.prototype=this.prototype),u.prototype=new e,u}),Array.prototype.includes||(Array.prototype.includes=function(n){null===this&&z("Array.prototype.includes called on null or undefined");var t=Object(this),r=parseInt(t.length,10)||0;if(0===r)return!1;var e,u=parseInt(arguments[1],10)||0;u>=0?e=u:(e=r+u,0>e&&(e=0));for(var i;r>e;){if(i=t[e],n===i||n!==n&&i!==i)return!0;e++}return!1}),Array.prototype.find||(Array.prototype.find=function(n){null===this&&z("Array.prototype.find called on null or undefined"),C(n)||z("predicate must be a function");for(var r,e=Object(this),u=e.length>>>0,i=arguments[1],o=0;u>o;o++)if(r=e[o],n.call(i,r,o,e))return r;return t}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(n){null==this&&z("Array.prototype.findIndex called on null or undefined"),"function"!=typeof n&&z("predicate must be a function");for(var t,r=Object(this),e=r.length>>>0,u=arguments[1],i=0;e>i;i++)if(t=r[i],n.call(u,t,i,r))return i;return-1},enumerable:!1,configurable:!1,writable:!1}),Object.keys||(Object.keys=function(n){x(n,"keys called on a non-object");var t=[];for(var r in n)Y(n,r)&&t.push(r);return t}),Object.values||(Object.values=function(n){x(n,"Object.values called on a non-object");var t=[];for(var r in n)Y(n,r)&&t.push(n[r]);return t}),Object.assign||(Object.assign=function(n){D(n)&&z("Cannot convert undefined or null to object");for(var t=Object(n),r=1;r<arguments.length;r++){var e=arguments[r];if(!D(e))for(var u in e)Y(e,u)&&(t[u]=e[u])}return t})}();var sn={key:"_id"};if(en.idKey=function(){return sn.key},en._internal=function(){return{assert:O.bind(null),computeValue:b.bind(null),each:G.bind(null),err:z.bind(null),falsey:U.bind(null),flatten:W.bind(null),groupBy:g.bind(null),has:Y.bind(null),hashcode:y.bind(null),inArray:R.bind(null),intersection:K.bind(null),isArray:M.bind(null),isBoolean:w.bind(null),isDate:S.bind(null),isEmpty:F.bind(null),isEqual:X.bind(null),isFunction:C.bind(null),isNull:N.bind(null),isNumber:A.bind(null),isObject:I.bind(null),isObjectLike:E.bind(null),isRegExp:q.bind(null),isString:k.bind(null),isUndefined:Q.bind(null),isUnknown:D.bind(null),keys:J.bind(null),map:H.bind(null),notInArray:P.bind(null),ops:d.bind(null),resolve:u.bind(null),resolveObj:i.bind(null),slice:tn.bind(null),stddev:nn.bind(null),stringify:ln.bind(null),sortBy:v.bind(null),truthy:L.bind(null),type:T.bind(null),union:V.bind(null),unique:Z.bind(null)}},en.setup=function(n){Object.assign(sn,n||{})},en.Query=function(n,t){return this instanceof en.Query?(this._criteria=n,this._projection=t,this._compiled=[],void this._compile()):new en.Query(n,t)},en.Query.prototype={_compile:function(){if(!F(this._criteria)){O(I(this._criteria),"Criteria must be of type Object");for(var n in this._criteria)if(Y(this._criteria,n)){var t=this._criteria[n];if(["$and","$or","$nor","$where"].includes(n))this._processOperator(n,n,t);else{t=h(t);for(var r in t)Y(t,r)&&this._processOperator(n,r,t[r])}}}},_processOperator:function(n,t,r){d(Cn).includes(t)?this._compiled.push(pn[t](n,r)):z("Invalid query operator '"+t+"' detected")},test:function(n){for(var t=0;t<this._compiled.length;t++)if(!this._compiled[t].test(n))return!1;return!0},find:function(n,t){return new en.Cursor(n,this,t)},remove:function(n){for(var t=[],r=0;r<n.length;r++)this.test(n[r])||t.push(n[r]);return t}},un){var cn=require("stream").Transform,fn=require("util");en.Query.prototype.stream=function(n){return new en.Stream(this,n)},en.Stream=function(n,t){return this instanceof en.Stream?(t=t||{},Object.assign(t,{objectMode:!0}),cn.call(this,t),void(this._query=n)):new en.Stream(n,t)},fn.inherits(en.Stream,cn),en.Stream.prototype._transform=function(n,t,r){if(I(n)&&this._query.test(n))if(F(this._query._projection))this.push(n);else{var e=new en.Cursor([n],this._query);e.hasNext()&&this.push(e.next())}r()}}en.Cursor=function(n,t,r){return this instanceof en.Cursor?(this._query=t,this._collection=n,this._projection=r||t._projection,this._operators={},this._result=!1,void(this._position=0)):new en.Cursor(n,t,r)},en.Cursor.prototype={_fetch:function(){var n=this;if(this._result!==!1)return this._result;I(this._projection)&&Object.assign(this._operators,{$project:this._projection}),M(this._collection)||z("Input collection is not of valid type. Must be an Array."),this._result=this._collection.filter(this._query.test,this._query);var t=[];if(G(["$sort","$skip","$limit","$project"],function(r){if(Y(n._operators,r)){var e={};e[r]=n._operators[r],t.push(e)}}),t.length>0){var r=new en.Aggregator(t);this._result=r.run(this._result,this._query)}return this._result},all:function(){return this._fetch()},first:function(){return this.count()>0?this._fetch()[0]:null},last:function(){return this.count()>0?this._fetch()[this.count()-1]:null},count:function(){return this._fetch().length},skip:function(n){return Object.assign(this._operators,{$skip:n}),this},limit:function(n){return Object.assign(this._operators,{$limit:n}),this},sort:function(n){return Object.assign(this._operators,{$sort:n}),this},next:function(){return this.hasNext()?this._fetch()[this._position++]:null},hasNext:function(){return this.count()>this._position},max:function(n){return $n.$max(this._fetch(),n)},min:function(n){return $n.$min(this._fetch(),n)},map:function(n){return this._fetch().map(n)},forEach:function(n){this._fetch().forEach(n)}},en.Aggregator=function(n){return this instanceof en.Aggregator?void(this._operators=n):new en.Aggregator(n)},en.Aggregator.prototype={run:function(n,t){if(!F(this._operators))for(var r=0;r<this._operators.length;r++){var e=this._operators[r],u=J(e);if(1===u.length&&d(Dn).includes(u[0])){u=u[0];var i={pipelineOp:u};n=t instanceof en.Query?hn[u].call(t,n,e[u],i):hn[u](n,e[u],i)}else z("Invalid aggregation operator '"+u+"'")}return n}},en.find=function(n,t,r){return new en.Query(t).find(n,r)},en.remove=function(n,t){return new en.Query(t).remove(n)},en.aggregate=function(n,t){return M(t)||z("Aggregation pipeline must be an array"),new en.Aggregator(t).run(n)},en.addOperators=function(n,t){var r=t(Object.assign({idKey:function(){return sn.key}},en._internal()));O([Qn,Nn,Dn,Pn,Cn].includes(n),"Could not identify operator class '"+n+"'");var e=d(n);G(r,function(t,r){O(/^\$\w+$/.test(r),"Invalid operator name '"+r+"'"),O(!e.includes(r),"Operator "+r+" is already defined for "+n+" operators")});var i={};switch(n){case Cn:G(r,function(n,t){i[t]=function(n,r){return function(e,i){return{test:function(o){var a=u(o,e),l=n.call(r,e,a,i);return w(l)?l:l instanceof en.Query?l.test(o):void z("Invalid return type for '"+t+"'. Must return a Boolean or Mingo.Query")}}}}(n,r)});break;case Pn:G(r,function(n,t){i[t]=function(n,t){return function(r,e,i){var o=u(r,i);return n.call(t,i,o,e)}}(n,r)});break;default:G(r,function(n,t){i[t]=function(n,t){return function(){var r=an.call(arguments);return n.apply(t,r)}}(n,r)})}Object.assign(Rn[n],i)},en.CollectionMixin={query:function(n,t){return en.find(this.toJSON(),n,t)},aggregate:function(n){return en.aggregate.call(null,this.toJSON(),n)}};var hn={$addFields:function(n,t){var r=J(t);return n.map(function(n){return n=s(n),G(r,function(r){var e,u=t[r];if(I(u)){var i=J(u),a=i.filter(function(n){return 0===n.indexOf("$")});F(a)||(O(1===i.length,"Can have only one root operator in $addFields"),a=a[0],u=u[a],e=b(n,u,a))}else e=b(n,u,null);o(n,r,function(n,t){n[t]=e},!0)}),n})},$group:function(n,t){var r=t[sn.key],e=g(n,function(n){return b(n,r,r)}),u=[];return delete t[sn.key],G(e.keys,function(n,r){var i={};Q(n)||(i[sn.key]=n);for(var o in t)Y(t,o)&&(i[o]=m(e.groups[r],o,t[o]));u.push(i)}),u},$match:function(n,t){return new en.Query(t).find(n).all()},$project:function(n,t){if(F(t))return n;for(var r=[],e=J(t),u=!1,o=[!1,!1],c=0;c<e.length;c++){var f=e[c],h=t[f];f!==sn.key&&(0===h||h===!1?o[0]=!0:o[1]=!0,O(o[0]!==o[1],"Projection cannot have a mix of inclusion and exclusion."))}if(e.includes(sn.key)){var p=t[sn.key];0!==p&&p!==!1||(e=e.filter(P.bind(null,[sn.key])),O(!e.includes(sn.key),"Must not contain collections _id"),u=F(e))}else e.push(sn.key);for(var c=0;c<n.length;c++){var v=n[c],g={},$=!1,y=!1,m=[];u&&m.push(sn.key),G(e,function(n){var r,e,u=t[n];if(n!==sn.key&&0===u&&(y=!0),n===sn.key&&F(u))r=v[n];else if(k(u))r=b(v,u,n);else if(1===u||u===!0);else{if(!I(u))return void m.push(n);var o=J(u);o=o.length>1?!1:o[0],d(Pn).includes(o)?"$slice"===o?B(u[o]).every(A)?(r=gn[o](v,u[o],n),$=!0):r=b(v,u,n):r=gn[o](v,u[o],n):r=b(v,u,n)}r=s(r),e=s(i(v,n)),Q(e)?Q(r)||(g[n]=r):(Q(r)||a(e,n,r),Object.assign(g,e))}),($||y||u)&&(g=Object.assign(s(v),g),G(m,function(n){l(g,n)})),r.push(g)}return r},$limit:function(n,t){return n.slice(0,t)},$skip:function(n,t){return n.slice(t)},$unwind:function(n,t){for(var r=[],u=t.substr(1),i=0;i<n.length;i++){var o=n[i],a=e(o,u);M(a)?G(a,function(n){var t=s(o);t[u]=n,r.push(t)}):z("Target field '"+u+"' is not of type Array.")}return r},$sort:function(n,t){if(!F(t)&&I(t)){var r=J(t);r.reverse().forEach(function(r){var e=g(n,function(n){return u(n,r)}),i={},o=function(n){return i[y(n)]},a=v(e.keys,function(n,t){return i[y(n)]=t,n});-1===t[r]&&a.reverse(),n=[],G(a,function(t){on.apply(n,e.groups[o(t)])})})}return n},$sortByCount:function(n,t){var r={count:{$sum:1}};return r[sn.key]=t,this.$sort(this.$group(n,r),{count:-1})},$sample:function(n,t){var r=t.size;O(A(r),"$sample size must be a positive integer. See https://docs.mongodb.com/manual/reference/operator/aggregation/sample/");for(var e=[],u=0;r>u;u++){var i=Math.floor(Math.random()*n.length);e.push(n[i])}return e},$count:function(n,t){O(k(t)&&""!==t.trim()&&-1===t.indexOf(".")&&"$"!==t.trim()[0],"Invalid expression value for $count. See https://docs.mongodb.com/manual/reference/operator/aggregation/count/");var r={};return r[t]=n.length,r},$replaceRoot:function(n,t){var r=t.newRoot,e=[];return G(n,function(n){n=b(n,r,null),O(I(n),"$replaceRoot expression must return a valid JS object. See https://docs.mongodb.com/manual/reference/operator/aggregation/replaceRoot/"),e.push(n)}),e},$redact:function(n,t){return n.map(function(n){return r(s(n),t)})}},pn={},dn={$and:function(n,t){O(M(t),"Invalid expression: $and expects value to be an Array");var r=[];return G(t,function(n){r.push(new en.Query(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(!r[t].test(n))return!1;return!0}}},$or:function(n,t){M(t)||z("Invalid expression for $or criteria");var r=[];return G(t,function(n){r.push(new en.Query(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(r[t].test(n))return!0;return!1}}},$nor:function(n,t){M(t)||z("Invalid expression for $nor criteria");var r=this.$or("$or",t);return{test:function(n){return!r.test(n)}}},$not:function(n,t){var r={};r[n]=h(t);var e=new en.Query(r);return{test:function(n){return!e.test(n)}}},$where:function(n,t){return C(t)||(t=new Function("return "+t+";")),{test:function(n){return t.call(n)===!0}}}};Object.assign(pn,dn);var vn={$eq:function(n,t){return X(n,t)||M(n)&&-1!==n.findIndex(X.bind(null,t))},$ne:function(n,t){return!this.$eq(n,t)},$in:function(n,t){return n=B(n),K(n,t).length>0},$nin:function(n,t){return Q(n)||!this.$in(n,t)},$lt:function(n,r){return n=B(n).find(function(n){return r>n}),n!==t},$lte:function(n,r){return n=B(n).find(function(n){return r>=n}),n!==t},$gt:function(n,r){return n=B(n).find(function(n){return n>r}),n!==t},$gte:function(n,r){return n=B(n).find(function(n){return n>=r}),n!==t},$mod:function(n,r){return n=B(n).find(function(n){return A(n)&&M(r)&&2===r.length&&n%r[0]===r[1]}),n!==t},$regex:function(n,r){return n=B(n).find(function(n){return k(n)&&q(r)&&!!n.match(r)}),n!==t},$exists:function(n,t){return t===!1&&Q(n)||t===!0&&!Q(n)},$all:function(n,t){var r=this,e=!1;if(M(n)&&M(t))for(var u=0;u<t.length;u++){if(!I(t[u])||!J(t[u]).includes("$elemMatch"))return K(t,n).length===t.length;e=e||r.$elemMatch(n,t[u].$elemMatch)}return e},$size:function(n,t){return M(n)&&A(t)&&n.length===t},$elemMatch:function(n,t){if(M(n)&&!F(n))for(var r=new en.Query(t),e=0;e<n.length;e++)if(r.test(n[e]))return!0;return!1},$type:function(n,t){switch(t){case 1:return A(n)&&-1!==(n+"").indexOf(".");case 2:case 5:return k(n);case 3:return I(n);case 4:return M(n);case 8:return w(n);case 9:return S(n);case 10:return N(n);case 11:return q(n);case 16:return A(n)&&2147483647>=n&&-1===(n+"").indexOf(".");case 18:return A(n)&&n>2147483647&&0x8000000000000000>=n&&-1===(n+"").indexOf(".");default:return!1}}};J(vn).forEach(function(n){pn[n]=function(n,t){return function(r,e){return{test:function(i){var o=u(i,r);return n.call(t,o,e)}}}}(vn[n],vn)});var gn={$:function(n,t,r){z("$ not implemented")},$elemMatch:function(n,r,e){var i=u(n,e),o=new en.Query(r);if(Q(i)||!M(i))return t;for(var a=0;a<i.length;a++)if(o.test(i[a]))return[i[a]];return t},$slice:function(n,t,r){var e=u(n,r);return M(e)?M(t)?tn(e,t[0],t[1]):A(t)?tn(e,t):void z("Invalid argument type for $slice projection operator"):e},$stdDevPop:function(n,t,r){var e=b(n,t,r);return nn({dataset:e,sampled:!1})},$stdDevSamp:function(n,t,r){var e=b(n,t,r);return nn({dataset:e,sampled:!0})}},$n={$addToSet:function(n,t){return Z(this.$push(n,t))},$sum:function(n,t){return M(n)?A(t)?n.length*t:this.$push(n,t).filter(A).reduce(function(n,t){return n+t},0):0},$max:function(n,t){var r,e=this.$push(n,t);return e.length>0&&(r=e[0],G(e,function(n){n>r&&(r=n)})),r},$min:function(n,t){var r,e=this.$push(n,t);return e.length>0&&(r=e[0],G(e,function(n){r>n&&(r=n)})),r},$avg:function(n,t){var r=this.$push(n,t).filter(A),e=r.reduce(function(n,t){return n+t},0);return e/(r.length||1)},$push:function(n,t){return D(t)?s(n):n.map(function(n){return b(n,t,null)})},$first:function(n,r){return n.length>0?b(n[0],r):t},$last:function(n,r){return n.length>0?b(n[n.length-1],r):t},$stdDevPop:function(n,t){var r=this.$push(n,t).filter(A);return nn({dataset:r,sampled:!1})},$stdDevSamp:function(n,t){var r=this.$push(n,t).filter(A);return nn({dataset:r,sampled:!0})}},yn={$abs:function(n,r){var e=b(n,r,null);return null===e||e===t?null:Math.abs(e)},$add:function(n,t){var r=b(n,t,null);return r.reduce(function(n,t){return n+t},0)},$subtract:function(n,t){var r=b(n,t,null);return r[0]-r[1]},$divide:function(n,t){var r=b(n,t,null);return r[0]/r[1]},$multiply:function(n,t){var r=b(n,t,null);return r.reduce(function(n,t){return n*t},1)},$mod:function(n,t){var r=b(n,t,null);return r[0]%r[1]}},mn={$concat:function(n,r){var e=b(n,r,null);return[null,t].some(R.bind(null,e))?null:e.join("")},$indexOfBytes:function(n,t){var r=b(n,t,null);if(D(r[0]))return null;O(k(r[0]),"$indexOfBytes first operand must resolve to a string"),O(k(r[1]),"$indexOfBytes second operand must resolve to a string");var e=r[0],u=r[1],i=r[2],o=r[3];if(O(Q(i)||A(i)&&i>=0&&Math.round(i)===i,"$indexOfBytes third operand must resolve to a non-negative integer"),i=i||0,O(Q(o)||A(o)&&o>=0&&Math.round(o)===o,"$indexOfBytes fourth operand must resolve to a non-negative integer"),o=o||e.length,i>o)return-1;var a=e.substring(i,o).indexOf(u);return a>-1?a+i:a},$split:function(n,t){var r=b(n,t,null);return O(k(r[0]),"$split requires an expression that evaluates to a string as a first argument, found: "+T(r[0])),O(k(r[1]),"$split requires an expression that evaluates to a string as a second argument, found: "+T(r[1])),r[0].split(r[1])},$strcasecmp:function(n,t){var r=b(n,t,null);return r[0]=F(r[0])?"":r[0].toUpperCase(),r[1]=F(r[1])?"":r[1].toUpperCase(),r[0]>r[1]?1:r[0]<r[1]?-1:0},$substr:function(n,t){var r=b(n,t,null);return k(r[0])?r[1]<0?"":r[2]<0?r[0].substr(r[1]):r[0].substr(r[1],r[2]):""},$toLower:function(n,t){var r=b(n,t,null);return F(r)?"":r.toLowerCase()},$toUpper:function(n,t){var r=b(n,t,null);return F(r)?"":r.toUpperCase()}},bn={$dayOfYear:function(n,r){var e=b(n,r,null);if(S(e)){var u=new Date(e.getFullYear(),0,0),i=e-u,o=864e5;return Math.round(i/o)}return t},$dayOfMonth:function(n,r){var e=b(n,r,null);return S(e)?e.getDate():t},$dayOfWeek:function(n,r){var e=b(n,r,null);return S(e)?e.getDay()+1:t},$year:function(n,r){var e=b(n,r,null);return S(e)?e.getFullYear():t},$month:function(n,r){var e=b(n,r,null);return S(e)?e.getMonth()+1:t},$week:function(n,t){var r=b(n,t,null);r=new Date(+r),r.setHours(0,0,0),r.setDate(r.getDate()+4-(r.getDay()||7));var e=new Date(r.getFullYear(),0,1);return Math.floor(((r-e)/864e5+1)/7)},$hour:function(n,r){var e=b(n,r,null);return S(e)?e.getHours():t},$minute:function(n,r){var e=b(n,r,null);return S(e)?e.getMinutes():t},$second:function(n,r){var e=b(n,r,null);return S(e)?e.getSeconds():t},$millisecond:function(n,r){var e=b(n,r,null);return S(e)?e.getMilliseconds():t},$dateToString:function(n,t){for(var r=t.format,e=b(n,t.date,null),u=r.match(/(%%|%Y|%m|%d|%H|%M|%S|%L|%j|%w|%U)/g),i=0,o=u.length;o>i;i++){var a=Ln[u[i]],l=a;if(M(a)){var s=this[a[0]],c=a[1];l=p(s.call(this,n,e),c)}r=r.replace(u[i],l)}return r}},On={$setEquals:function(n,t){var r=b(n,t,null),e=Z(r[0]),u=Z(r[1]);return e.length===u.length&&e.length===K(e,u).length},$setIntersection:function(n,t){var r=b(n,t,null);return K(r[0],r[1])},$setDifference:function(n,t){var r=b(n,t,null);return r[0].filter(P.bind(null,r[1]))},$setUnion:function(n,t){var r=b(n,t,null);return V(r[0],r[1])},$setIsSubset:function(n,t){var r=b(n,t,null);return K(r[0],r[1]).length===r[0].length},$anyElementTrue:function(n,t){var r=b(n,t,null)[0];return r.some(L)},$allElementsTrue:function(n,t){var r=b(n,t,null)[0];return r.every(L)}},_n={$cond:function(n,t){var r,e,u;M(t)?(3!=t.length&&z("Invalid arguments for $cond operator"),r=t[0],e=t[1],u=t[2]):I(t)&&(r=t["if"],e=t.then,u=t["else"]);var i=b(n,r,null);return i?b(n,e,null):b(n,u,null)},$switch:function(n,t){t.branches||z("Invalid arguments for $switch operator");var r=t.branches.find(function(t){return t["case"]&&t.then||z("Invalid arguments for $switch operator"),b(n,t["case"],null)});return r?b(n,r.then,null):t["default"]?b(n,t["default"],null):void z("Invalid arguments for $switch operator")},$ifNull:function(n,r){O(M(r)&&2===r.length,"Invalid arguments for $ifNull operator");var e=b(n,r,null);return null===e[0]||e[0]===t?e[1]:e[0]}},xn={$cmp:function(n,t){var r=b(n,t,null);return r[0]>r[1]?1:r[0]<r[1]?-1:0}};["$eq","$ne","$gt","$gte","$lt","$lte","$in","$nin"].forEach(function(n){xn[n]=function(t,r){var e=b(t,r,null);return vn[n](e[0],e[1])}});var jn={$arrayElemAt:function(n,r){var e=b(n,r,null);O(M(e)&&2===e.length,"$arrayElemAt expression must resolve to an array of 2 elements"),O(M(e[0]),"First operand to $arrayElemAt must resolve to an array"),O(A(e[1]),"Second operand to $arrayElemAt must resolve to an integer");var u=e[1];return e=e[0],0>u&&Math.abs(u)<=e.length?e[u+e.length]:u>=0&&u<e.length?e[u]:t},$concatArrays:function(n,t){var r=b(n,t,null);return O(M(r)&&2===r.length,"$concatArrays expression must resolve to an array of 2 elements"),r.some(D)?null:r[0].concat(r[1])},$filter:function(n,t){var r=b(n,t.input,null),e=t.as,u=t.cond;return O(M(r),"'input' expression for $filter must resolve to an array"),r.filter(function(n){var t={};return t["$"+e]=n,b(t,u,null)===!0})},$indexOfArray:function(n,t){var r=b(n,t,null);if(D(r))return null;var e=r[0];if(D(e))return null;O(M(e),"First operand for $indexOfArray must resolve to an array.");var u=r[1];if(D(u))return null;var i=r[2]||0,o=r[3]||e.length;return o<e.length&&(e=e.slice(i,o)),e.indexOf(u,i)},$isArray:function(n,t){return M(b(n,t,null))},$range:function(n,t){for(var r=b(n,t,null),e=r[0],u=r[1],i=r[2]||1,o=[];u>e&&i>0||e>u&&0>i;)o.push(e),e+=i;return o},$reverseArray:function(n,t){var r=b(n,t,null);return D(r)?null:(O(M(r),"$reverseArray expression must resolve to an array"),r=s(r),r.reverse(),r)},$reduce:function(n,t){var r=b(n,t.input,null),e=b(n,t.initialValue,null),u=t["in"];return D(r)?null:(O(M(r),"'input' expression for $reduce must resolve to an array"),r.reduce(function(n,t){return b({$value:n,$this:t},u,null)},e))},$size:function(n,r){var e=b(n,r,null);return M(e)?e.length:t},$slice:function(n,t){var r=b(n,t,null);return tn(s(r[0]),r[1],r[2])},$zip:function(n,t){var r=b(n,t.inputs,null),e=t.useLongestLength||!1;O(M(r),"'inputs' expression must resolve to an array"),O(w(e),"'useLongestLength' must be a boolean"),M(t.defaults)&&O(L(e),"'useLongestLength' must be set to true to use 'defaults'");for(var u=0,i=0;i<r.length;i++){var o=r[i];if(D(o))return null;O(M(o),"'inputs' expression values must resolve to an array or null"),u=e?Math.max(u,o.length):Math.min(u||o.length,o.length)}for(var a=[],l=t.defaults||[],i=0;u>i;i++){var o=r.map(function(n,t){return D(n[i])?l[t]||null:n[i]});a.push(o)}return a}},wn={$literal:function(n,t){return t}},kn={$map:function(n,t){var r=b(n,t.input,null);M(r)||z("Input expression for $map must resolve to an array");var e=t.as,u=t["in"],i="$"+e,o=n[i];return r.map(function(t){n[i]=t;var r=b(n,u,null);return Q(o)?delete n[i]:n[i]=o,r})},$let:function(n,t){var r=t.vars,e=t["in"],u={},i=J(r);G(i,function(t){var e=b(n,r[t],null),i="$"+t;u[i]=n[i],n[i]=e});var o=b(n,e,null);return G(i,function(t){var r="$"+t;Q(u[r])?delete n[r]:n[r]=u[r]}),o}},An={$and:function(n,t){var r=b(n,t,null);return L(r)&&r.every(L)},$or:function(n,t){var r=b(n,t,null);return L(r)&&r.some(L)},$not:function(n,t){return!b(n,t[0],null)}},Mn=Object.assign({},jn,yn,An,xn,_n,bn,wn,On,mn,kn),In={$$ROOT:function(n,t,r){return r.root},$$CURRENT:function(n,t,r){return n}},En={$$KEEP:function(n,t,r){return n},$$PRUNE:function(n,r,e){return t},$$DESCEND:function(n,t,e){if(!Y(t,"$cond"))return n;var u;return G(n,function(i,o){E(i)&&(M(i)?(u=[],G(i,function(n,i){I(n)&&(n=r(n,t,e)),Q(n)||u.push(n)})):u=r(i,t,e),Q(u)?delete n[o]:n[o]=u)}),n}},Sn=J(In),qn=J(En),Cn=en.OP_QUERY="query",Nn=en.OP_GROUP="group",Qn=en.OP_AGGREGATE="aggregate",Dn=en.OP_PIPELINE="pipeline",Pn=en.OP_PROJECTION="projection",Rn={aggregate:Mn,group:$n,pipeline:hn,projection:gn,query:pn},Ln={"%Y":["$year",4],"%m":["$month",2],"%d":["$dayOfMonth",2],"%H":["$hour",2],"%M":["$minute",2],"%S":["$second",2],"%L":["$millisecond",3],"%j":["$dayOfYear",3],"%w":["$dayOfWeek",1],"%U":["$week",2],"%%":"%"},Un=[k,w,A,S,D,q]}(this);
//# sourceMappingURL=dist/mingo.min.map