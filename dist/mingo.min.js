//! mingo.js 3.0.0
//! Copyright (c) 2020 Francis Asante
//! MIT
!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((n=n||self).mingo={})}(this,function(g){"use strict";function c(n){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n})(n)}function s(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")}function e(n,t){for(var r=0;r<t.length;r++){var e=t[r];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(n,e.key,e)}}function n(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}function u(n){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(n){return n.__proto__||Object.getPrototypeOf(n)})(n)}function o(n,t){return(o=Object.setPrototypeOf||function(n,t){return n.__proto__=t,n})(n,t)}function i(n,t,r){return(i=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(n){return}}}()?Reflect.construct:function(n,t,r){var e=[null];e.push.apply(e,t);var u=new(Function.bind.apply(n,e));return r&&o(u,r.prototype),u}).apply(null,arguments)}function a(n){var e="function"==typeof Map?new Map:void 0;return(a=function(n){if(null===n||(t=n,-1===Function.toString.call(t).indexOf("[native code]")))return n;var t;if("function"!=typeof n)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(n))return e.get(n);e.set(n,r)}function r(){return i(n,arguments,u(this).constructor)}return r.prototype=Object.create(n.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),o(r,n)})(n)}function f(n,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(n){if(void 0===n)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}(n):t}function l(n){return function(n){if(Array.isArray(n)){for(var t=0,r=new Array(n.length);t<n.length;t++)r[t]=n[t];return r}}(n)||function(n){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n))return Array.from(n)}(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var v,t,p,r,h=2147483647,d=-2147483648,m=Number.MAX_SAFE_INTEGER,y=Number.MIN_SAFE_INTEGER,$=function(){};(t=v=v||{}).NULL="null",t.UNDEFINED="undefined",t.BOOLEAN="boolean",t.NUMBER="number",t.STRING="string",t.DATE="date",t.REGEXP="regexp",t.ARRAY="array",t.OBJECT="object",t.FUNCTION="function",(r=p=p||{}).BOOL="bool",r.INT="int",r.LONG="long",r.DOUBLE="double",r.DECIMAL="decimal",r.REGEX="regex",Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(n,t){if(null==this)throw new TypeError('"this" is null or not defined');var r=Object(this),e=r.length>>>0;if(0==e)return!1;var u,o,i=0|t,a=Math.max(0<=i?i:e-Math.abs(i),0);for(;a<e;){if((u=r[a])===(o=n)||"number"==typeof u&&"number"==typeof o&&isNaN(u)&&isNaN(o))return!0;a++}return!1}});var b=[v.NULL,v.UNDEFINED,v.BOOLEAN,v.NUMBER,v.STRING,v.DATE,v.REGEXP];function _(n,t){if(!n)throw new Error(t)}function O(n){return M(n)?n.map(O):S(n)?new Date(n):k(n)?X(n,O):n}function E(n){return M(n)?sn([],n):S(n)?new Date(n):k(n)?Object.assign({},n):n}function x(n){return null===n?"Null":void 0===n?"Undefined":n.constructor.name}function A(n){return x(n).toLowerCase()}function N(n){return c(n)===v.BOOLEAN}function w(n){return c(n)===v.STRING}function T(n){return!isNaN(n)&&c(n)===v.NUMBER}var M=Array.isArray||function(n){return n instanceof Array};function k(n){return!!n&&n.constructor===Object}function R(n){return n===Object(n)}function S(n){return n instanceof Date}function j(n){return n instanceof RegExp}function U(n){return c(n)===v.FUNCTION}function L(n){return null==n}function C(n){return null===n}function I(n){return void 0===n}function D(n,t){return n.includes(t)}function P(n,t){return!D(n,t)}function B(n){return!!n}function F(n){return L(n)||M(n)&&0===n.length||k(n)&&0===Y(n).length||!n}function G(n){return n instanceof Array?n:[n]}function z(n,t){return!!n&&n.hasOwnProperty(t)}var Y=Object.keys;function q(n,t){if(n instanceof Array)for(var r=n,e=0,u=r.length;e<u&&!1!==t(r[e],e);e++);else for(var o in n)if(z(n,o)&&!1===t(n[o],o))break}function X(n,t){for(var r={},e=Y(n),u=0;u<e.length;u++){var o=e[u];r[o]=t(n[o],o)}return r}function H(t,r,e){if(t===$)return r;if(r===$)return t;var n=[t,r];if(!n.every(k)&&!n.every(M))throw Error("mismatched types. must both be array or object");if(e.flatten=e.flatten||!1,M(t)){var u=t,o=r;if(e.flatten){for(var i=0,a=0;i<u.length&&a<o.length;)u[i]=H(u[i++],o[a++],e);for(;a<o.length;)u.push(r[a++])}else Array.prototype.push.apply(u,o)}else Object.keys(r).forEach(function(n){z(t,n)?t[n]=H(t[n],r[n],e):t[n]=r[n]});return t}function J(r,e,u){return Array.isArray(r)?r.reduce(e,u):(q(r,function(n,t){return u=e(u,n,t,r)}),u)}function V(t,n){var r=!1;if(t.length>n.length){var e=t;t=n,n=e,r=!0}for(var u=Math.max(t.length,n.length),o=Math.min(t.length,n.length),i=t.reduce(function(n,t,r){return n[tn(t)]=r,n},{}),a=[],s=0,c=0;s<u&&c<o;s++){var f=i[tn(n[s])];void 0!==f&&(a.push(f),c++)}return r||a.sort(),a.map(function(n){return t[n]})}function Z(n,t){var o=[];return function n(t,r){for(var e=0,u=t.length;e<u;e++)M(t[e])&&(0<r||r<0)?n(t[e],Math.max(-1,r-1)):o.push(t[e])}(n,1<arguments.length&&void 0!==t?t:-1),o}function K(n,t){if(t<1)return n;for(;t--&&M(n)&&1===n.length;)n=n[0];return n}function Q(n,t){for(var r=[n],e=[t];0<r.length;)if((n=r.pop())!==(t=e.pop())){var u=A(n);if(u!==A(t)||u===v.FUNCTION)return!1;switch(u){case v.ARRAY:if(n.length!==t.length)return!1;if(n.length===t.length&&0===n.length)continue;sn(r,n),sn(e,t);break;case v.OBJECT:var o=Y(n),i=Y(t);if(o.length!==i.length)return!1;o.sort(),i.sort();for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c!==i[a])return!1;r.push(n[c]),e.push(t[c])}break;default:if(nn(n)!==nn(t))return!1}}return 0===r.length}function W(n){var r={},e=[];return q(n,function(n){var t=tn(n);z(r,t)||(e.push(n),r[t]=0)}),e}function nn(t){var n=A(t);switch(n){case v.BOOLEAN:case v.NUMBER:case v.REGEXP:return t.toString();case v.STRING:return JSON.stringify(t);case v.DATE:return t.toISOString();case v.NULL:case v.UNDEFINED:return n;case v.ARRAY:return"["+t.map(nn)+"]";default:var r=n===v.OBJECT?"":"".concat(x(t)),e=Y(t);return e.sort(),"".concat(r,"{")+e.map(function(n){return"".concat(nn(n),":").concat(nn(t[n]))})+"}"}}function tn(n){if(L(n))return null;for(var t=0,r=nn(n),e=r.length;e;)t=(t<<5)-t^r.charCodeAt(--e);return t>>>0}function rn(n,t){return n<t?-1:t<n?1:0}function en(n,t,r){var e=[],u=[],o=new Object;if(r=r||rn,F(n))return n;for(var i=0;i<n.length;i++){var a=n[i],s=t(a,i);L(s)?u.push(a):(o[s]?o[s].push(a):o[s]=[a],e.push(s))}e.sort(r);for(var c=0;c<e.length;c++)sn(u,o[e[c]]);return u}function un(n,u){var o={keys:[],groups:[]},i={};return q(n,function(n){var t=u(n),r=tn(t),e=-1;void 0===i[r]&&(e=o.keys.length,i[r]=e,o.keys.push(t),o.groups.push([])),e=i[r],o.groups[e].push(n)}),o}var on,an=5e4;function sn(n,t){for(var r=Math.ceil(t.length/an),e=0;0<r--;)Array.prototype.push.apply(n,t.slice(e,e+an)),e+=an;return n}function cn(u){var o,i=this;return o={},function(){for(var n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];var e=tn(t);return z(o,e)||(o[e]=u.apply(i,t)),o[e]}}function fn(n,t){return R(n)?n[t]:void 0}function ln(n,t,r){var i=0;return void 0===r&&(r={preserveMetadata:!1}),n=D(b,A(n))?n:function e(n,u){for(var t=n,r=0;r<u.length;r++){var o=u[r];if(null===o.match(/^\d+$/)&&Array.isArray(t)){if(0===r&&0<i)break;i+=1,u=u.slice(r),t=J(t,function(n,t){var r=e(t,u);return void 0!==r&&n.push(r),n},[]);break}if(void 0===(t=fn(t,o)))break}return t}(n,t.split(".")),!0===r.preserveMetadata?{result:n,depth:i}:n}function vn(n,t,r){void 0===r&&(r={preserveMissing:!1});var e,u,o=t.split("."),i=o[0],a=o.slice(1).join("."),s=null!==i.match(/^\d+$/),c=1<o.length;if(n instanceof Array)s?(e=fn(n,Number(i)),c&&(e=vn(e,a,r)),e=[e]):(e=[],q(n,function(n){u=vn(n,t,r),r.preserveMissing?(void 0===u&&(u=$),e.push(u)):void 0!==u&&e.push(u)}));else{if(u=fn(n,i),c&&(u=vn(u,a,r)),void 0===u)return;(e={})[i]=u}return e}function pn(n){if(Array.isArray(n))for(var t=n.length-1;0<=t;t--)n[t]===$?n.splice(t,1):pn(n[t]);else if(k(n))for(var r in n)z(n,r)&&pn(n[r]);return n}function hn(n,t,r,e){var u=t.split("."),o=u[0],i=u.slice(1).join(".");1===u.length?r(n,o):(!0===e&&L(n[o])&&(n[o]={}),hn(n[o],i,r,e))}function dn(n,t,r){hn(n,t,function(n,t){n[t]=r},!0)}function gn(n,t){hn(n,t,function(n,t){n instanceof Array&&/^\d+$/.test(t)?n.splice(parseInt(t),1):k(n)&&delete n[t]})}function mn(n){return!!n&&"$"===n[0]}function yn(n){if(D(b,A(n)))return j(n)?{$regex:n}:{$eq:n};if(R(n)){if(!Y(n).some(mn))return{$eq:n};z(n,"$regex")&&(n.$regex=new RegExp(n.$regex,n.$options),delete n.$options)}return n}function $n(n,t,r){return L(r)?t<0?(t=Math.max(0,n.length+t),r=n.length-t+1):(r=t,t=0):(t<0&&(t=Math.max(0,n.length+t)),_(0<r,"Invalid argument value for $slice operator. Limit must be a positive number"),r+=t),n.slice(t,r)}function bn(n,t){var r=J(n,function(n,t){return n+t},0),e=n.length||1,u=t?1:0,o=r/e;return Math.sqrt(J(n,function(n,t){return n+Math.pow(t-o,2)},0)/(e-u))}function _n(){return{clone:E,cloneDeep:O,filterMissing:pn,hashCode:tn,isArray:M,isBoolean:N,isDate:S,isEmpty:F,isEqual:Q,isFunction:U,isNil:L,isNull:C,isNumber:T,isObject:k,isRegExp:j,isString:w,isUndefined:I,resolve:ln,resolveGraph:vn}}(on=g.OperatorType||(g.OperatorType={})).ACCUMULATOR="accumulator",on.EXPRESSION="expression",on.PIPELINE="pipeline",on.PROJECTION="projection",on.QUERY="query";var On={};function En(n,t){Object.assign(On[n],t)}function xn(n,t){return z(On[n],t)?On[n][t]:null}q(g.OperatorType,function(n){On[n]={}});var An={key:"_id"};var Nn={$$ROOT:function(n,t,r){return r.root},$$CURRENT:function(n){return n},$$REMOVE:function(){}},wn={$$KEEP:function(n){return n},$$PRUNE:function(){},$$DESCEND:function(r,e,u){return z(e,"$cond")&&q(r,function(n,t){R(n)&&(M(n)?(o=[],q(n,function(n){k(n)&&(n=Rn(n,e,u)),L(n)||o.push(n)})):o=Rn(n,e,u),L(o)?delete r[t]:r[t]=o)}),r;var o}};function Tn(){return An.key}function Mn(r,n,e){var t=xn(g.OperatorType.ACCUMULATOR,n);if(t)return t(r,e);if(k(e)){var u={};return q(e,function(n,t){if(u[t]=Mn(r,t,e[t]),xn(g.OperatorType.ACCUMULATOR,t))return u=u[t],_(1===Y(e).length,"Invalid $group expression '"+JSON.stringify(e)+"'"),!1}),u}}function kn(r,e,n,u){void 0===u&&(u={root:r});var t=xn(g.OperatorType.EXPRESSION,n);if(t)return t(r,e,u);if(t=xn(g.OperatorType.ACCUMULATOR,n))return r=kn(r,e,null,u),_(M(r),n+" expression must resolve to an array"),t(r,null,u);if(w(e)&&0<e.length&&"$"===e[0]){if(z(wn,e))return e;var o=e.split(".");if(z(Nn,o[0])){if(r=Nn[o[0]](r,null,u),1==o.length)return r;e=e.substr(o[0].length)}return ln(r,e.slice(1))}if(Array.isArray(e))return e.map(function(n){return kn(r,n)});if(k(e)){var i={};return q(e,function(n,t){if(i[t]=kn(r,n,t,u),[g.OperatorType.EXPRESSION,g.OperatorType.ACCUMULATOR].some(function(n){return z(On[n],t)}))return _(1===Y(e).length,"Invalid aggregation expression '"+JSON.stringify(e)+"'"),i=i[t],!1}),i}return e}function Rn(n,t,r){var e=kn(n,t,null,r);return z(wn,e)?wn[e](n,t,r):e}function Sn(n,t){return L(t)?n:n.map(function(n){return kn(n,t)})}var jn=Object.freeze({__proto__:null,$addToSet:function(n,t){return W(Sn(n,t))},$avg:function(n,t){var r=Sn(n,t).filter(T);return J(r,function(n,t){return n+t},0)/(r.length||1)},$first:function(n,t){return 0<n.length?kn(n[0],t):void 0},$last:function(n,t){return 0<n.length?kn(n[n.length-1],t):void 0},$max:function(n,t){return J(Sn(n,t),function(n,t){return L(n)||n<t?t:n},void 0)},$mergeObjects:function(n,r){return J(n,function(n,t){return Object.assign(n,kn(t,r))},{})},$min:function(n,t){return J(Sn(n,t),function(n,t){return L(n)||t<n?t:n},void 0)},$push:Sn,$stdDevPop:function(n,t){return bn(Sn(n,t).filter(T),!1)},$stdDevSamp:function(n,t){return bn(Sn(n,t).filter(T),!0)},$sum:function(n,t){return M(n)?T(t)?n.length*t:J(Sn(n,t).filter(T),function(n,t){return n+t},0):0}});function Un(n,t,r){var e=Math.abs(n)===n?1:-1;n=Math.abs(n);var u=Math.trunc(n),o=n-u;if(0===t){var i=Math.trunc(10*o);r&&1==(1&u)&&5<=i&&u++}else if(0<t){var a=Math.pow(10,t),s=Math.trunc(o*a),c=Math.trunc(o*a*10)%10;r&&5<c&&(s+=1),u+=s/a}else if(t<0){var f=Math.pow(10,-1*t),l=u%f;if(u=Math.max(0,u-l),r&&-1==e){for(;10<l;)l-=l%10;0<u&&5<=l&&(u+=f)}}return u*e}function Ln(n){return n instanceof Bn?n:new Bn(n)}var Cn,In,Dn=new Error;function Pn(c,f,l){var v=!1,p=-1,h=0;return function(n){try{n:for(;!v;){var t=c();p++;for(var r=-1,e=f.length,u=!1;++r<e;){var o=f[r];switch(o.action){case Cn.MAP:t=o.value(t,p);break;case Cn.FILTER:if(!o.value(t,p))continue n;break;case Cn.TAKE:--o.value,o.value||(u=!0);break;case Cn.DROP:--o.value,o.value||(a=r,s=(i=f).slice(a+1),i.splice(a),Array.prototype.push.apply(i,s));continue n;default:break n}}if(v=u,!n)return{value:t,done:!1};l[h++]=t}}catch(n){if(n!==Dn)throw n}var i,a,s;return{done:v=!0}}}(In=Cn=Cn||{})[In.MAP=0]="MAP",In[In.FILTER=1]="FILTER",In[In.TAKE=2]="TAKE",In[In.DROP=3]="DROP";var Bn=function(){function a(n){var t,r;if(s(this,a),this.__iteratees=[],this.__first=!1,this.__done=!1,this.__buf=[],n instanceof Function&&(n={next:n}),(r=n)&&"object"===c(r)&&r.next instanceof Function){var e=n;t=function(){var n=e.next();if(n.done)throw Dn;return n.value}}else if(Array.isArray(n)){var u=n,o=u.length,i=0;t=function(){if(i<o)return u[i++];throw Dn}}else if(!(n instanceof Function))throw new Error("Source is not iterable. Must be Array, Function, or Generator");this.__next=Pn(t,this.__iteratees,this.__buf)}return n(a,[{key:"_validate",value:function(){if(this.__first)throw new Error("Cannot add iteratee/transform after `first()`")}},{key:"_push",value:function(n,t){return this._validate(),this.__iteratees.push({action:n,value:t}),this}},{key:"next",value:function(){return this.__next()}},{key:"map",value:function(n){return this._push(Cn.MAP,n)}},{key:"filter",value:function(n){return this._push(Cn.FILTER,n)}},{key:"take",value:function(n){return 0<n?this._push(Cn.TAKE,n):this}},{key:"drop",value:function(n){return 0<n?this._push(Cn.DROP,n):this}},{key:"transform",value:function(n){this._validate();var t,r=this;return Ln(function(){return(t=t||Ln(n(r.value()))).next()})}},{key:"first",value:function(){return this.take(1),this.__first=!0,this}},{key:"value",value:function(){return this.__done||(this.__done=this.__next(!0).done),this.__first?this.__buf[0]:this.__buf}},{key:"each",value:function(n){for(;;){var t=this.next();if(t.done)break;if(!1===n(t.value))return!1}return!0}},{key:"reduce",value:function(n,t){var r=this.next(),e=0;for(void 0!==t||r.done||(t=r.value,r=this.next(),e++);!r.done;)t=n(t,r.value,e++),r=this.next();return t}},{key:"size",value:function(){return this.reduce(function(n,t){return++n},0)}}]),a}();"function"==typeof Symbol&&(Bn.prototype[Symbol.iterator]=function(){return this});var Fn=function(){function r(n,t){s(this,r),this.__operators=n,this.__options=t}return n(r,[{key:"stream",value:function(n){var u=this,o=Ln(n);return F(this.__operators)||q(this.__operators,function(n){var t=Y(n),r=t[0],e=xn(g.OperatorType.PIPELINE,r);_(1===t.length&&!!e,"invalid aggregation operator ".concat(r)),o=e(o,n[r],u.__options)}),o}},{key:"run",value:function(n){return this.stream(n).value()}}]),r}();function Gn(n,t,r){return _(M(t),"Aggregation pipeline must be an array"),new Fn(t,r).run(n)}var zn=function(){function e(n,t,r){s(this,e),this.__predicate=t,this.__source=n,this.__projection=r,this.__operators=[],this.__result=null,this.__stack=[],this.__options={}}return n(e,[{key:"_fetch",value:function(){return this.__result||(k(this.__projection)&&this.__operators.push({$project:this.__projection}),this.__result=Ln(this.__source).filter(this.__predicate),0<this.__operators.length&&(this.__result=new Fn(this.__operators,this.__options).stream(this.__result))),this.__result}},{key:"all",value:function(){return this._fetch().value()}},{key:"count",value:function(){return this.all().length}},{key:"skip",value:function(n){return this.__operators.push({$skip:n}),this}},{key:"limit",value:function(n){return this.__operators.push({$limit:n}),this}},{key:"sort",value:function(n){return this.__operators.push({$sort:n}),this}},{key:"collation",value:function(n){return this.__options.collation=n,this}},{key:"next",value:function(){if(this.__stack){if(0<this.__stack.length)return this.__stack.pop();var n=this._fetch().next();if(!n.done)return n.value;this.__stack=null}}},{key:"hasNext",value:function(){if(!this.__stack)return!1;if(0<this.__stack.length)return!0;var n=this._fetch().next();return n.done?this.__stack=null:this.__stack.push(n.value),!!this.__stack}},{key:"map",value:function(n){return this._fetch().map(n).value()}},{key:"forEach",value:function(n){this._fetch().each(n)}}]),e}();"function"==typeof Symbol&&(zn.prototype[Symbol.iterator]=function(){return this._fetch()});var Yn=function(){function t(n){s(this,t),this.__criteria=n,this.__compiled=[],this._compile()}return n(t,[{key:"_compile",value:function(){var t,e=this;_(k(this.__criteria),"query criteria must be an object"),q(this.__criteria,function(n,r){"$where"===r?t={field:r,expr:n}:"$expr"===r||D(["$and","$or","$nor"],r)?e._processOperator(r,r,n):(_(!mn(r),"unknown top level operator: ".concat(r)),q(n=yn(n),function(n,t){e._processOperator(r,t,n)})),k(t)&&e._processOperator(t.field,t.field,t.expr)})}},{key:"_processOperator",value:function(n,t,r){var e=xn(g.OperatorType.QUERY,t);_(!!e,"unknown operator ".concat(t)),this.__compiled.push(e(n,r))}},{key:"test",value:function(n){for(var t=0,r=this.__compiled.length;t<r;t++)if(!this.__compiled[t](n))return!1;return!0}},{key:"find",value:function(n,t){var r=this;return new zn(n,function(n){return r.test(n)},t)}},{key:"remove",value:function(n){var r=this;return J(n,function(n,t){return r.test(t)||n.push(t),n},[])}}]),t}();function qn(u){return function(r,e){return function(n){var t=ln(n,r,{preserveMetadata:!0});return t=K(t.result,t.depth),u(t,e)}}}function Xn(e){return function(n,t){var r=kn(n,t);return e.apply(void 0,l(r))}}function Hn(n,t){if(Q(n,t))return!0;if(L(n)&&L(t))return!0;if(M(n)){var r=Q.bind(null,t);return n.some(r)||Z(n,1).some(r)}return!1}function Jn(n,t){return!Hn(n,t)}function Vn(n,t){return L(n)?t.some(C):0<V(G(n),t).length}function Zn(n,t){return!Vn(n,t)}function Kn(n,t){return rt(n,t,function(n,t){return n<t})}function Qn(n,t){return rt(n,t,function(n,t){return n<=t})}function Wn(n,t){return rt(n,t,function(n,t){return t<n})}function nt(n,t){return rt(n,t,function(n,t){return t<=n})}function tt(n,t){if(0<n.length){var r=function(n){return n},e=t;Y(t).every(mn)&&(e={temp:t},r=function(n){return{temp:n}});for(var u=new Yn(e),o=0,i=n.length;o<i;o++)if(u.test(r(n[o])))return!0}return!1}function rt(n,t,r){return G(n).some(function(n){return x(n)===x(t)&&r(n,t)})}var et=Xn(Zn);var ut=Xn(Hn),ot=Xn(Wn),it=Xn(nt),at=Xn(Kn),st=Xn(Qn),ct=Xn(Jn);function ft(n,t){var r=kn(n,t);if(S(r))return r;if(w(decodeURI))throw Error("cannot take a string as an argument");var e=0;if(k(r)&&(e=_t(kn(n,r.timezone)),r=kn(n,r.date)),r=new Date(r),isNaN(r.getTime()))throw Error("cannot convert ".concat(n," to date"));return r.setUTCHours(r.getUTCHours()+e),r}function lt(n,t){return ft(n,t).getUTCDate()}function vt(n,t){return ft(n,t).getUTCDay()+1}function pt(n,t){return ft(n,t).getUTCFullYear()}function ht(n,t){return ft(n,t).getUTCMonth()+1}function dt(n,t){var r=ft(n,t);(r=new Date(+r)).setHours(0,0,0),r.setDate(r.getDate()+4-(r.getDay()||7));var e=new Date(r.getFullYear(),0,1);return Math.floor(((r.getTime()-e.getTime())/864e5+1)/7)}function gt(n,t){return ft(n,t).getUTCHours()}function mt(n,t){return ft(n,t).getUTCMinutes()}function yt(n,t){return ft(n,t).getUTCSeconds()}function $t(n,t){return ft(n,t).getUTCMilliseconds()}var bt={"%Y":["year",pt,4,/([0-9]{4})/],"%G":["year",pt,4,/([0-9]{4})/],"%m":["month",ht,2,/(0[1-9]|1[012])/],"%d":["day",lt,2,/(0[1-9]|[12][0-9]|3[01])/],"%H":["hour",gt,2,/([01][0-9]|2[0-3])/],"%M":["minute",mt,2,/([0-5][0-9])/],"%S":["second",yt,2,/([0-5][0-9]|60)/],"%L":["millisecond",$t,3,/([0-9]{3})/],"%u":["weekDay",vt,1,/([1-7])/],"%V":["week",dt,1,/([1-4][0-9]?|5[0-3]?)/],"%z":["timezone",null,0,/([+-]([01][0-9]|2[0-3]):?([0-5][0-9])?)/],"%Z":["minuteOffset",null,0,/([+-][0-9]{3})/],"%%":"%"};function _t(n){var t=bt["%z"][3];if(null==n)return 0;if(!n.match(t))throw Error("invalid or location-based timezone ".concat(n," not supported"));return parseInt(n.substr(0,3))}function Ot(n,t){for(var r,e,u=kn(n,t.format),o=kn(n,t.date),i=u.match(/(%%|%Y|%G|%m|%d|%H|%M|%S|%L|%u|%V|%z|%Z)/g),a=0,s=i.length;a<s;a++){var c=bt[i[a]],f=void 0;if(Array.isArray(c)){var l=c[1],v=c[2];r=l(n,o),e=v,f=new Array(Math.max(e-String(r).length+1,0)).join("0")+r}else f=c;u=u.replace(i[a],f)}return u}function Et(t){return"^.-*?$".split("").forEach(function(n){t=t.replace(n,"\\".concat(n))}),t}var xt=["dateString","format","timezone","onError","onNull"];function At(e){return function(){var n,t=u(e);if(function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(n){return}}}()){var r=u(this).constructor;n=Reflect.construct(t,arguments,r)}else n=t.apply(this,arguments);return f(this,n)}}var Nt=function(){!function(n,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),t&&o(n,t)}(r,a(Error));var t=At(r);function r(n){return s(this,r),t.call(this,n)}return r}();function wt(n,t){var r=kn(n,t);return null==r?null:Boolean(r)}function Tt(n,t){var r=kn(n,t);return null==r?null:r instanceof Date?Ot(n,{date:t,format:"%Y-%m-%dT%H:%M:%S.%LZ"}):r.toString()}function Mt(n,t,r,e,u){var o=kn(n,t);if(null==o)return null;if(o instanceof Date)return o.getTime();var i=Math.trunc(Number(o));if(!isNaN(i)&&e<=i&&i<=r&&(!w(o)||/^\d+$/.test(o)))return i;throw new Nt("cannot convert '".concat(o,"' to ").concat(u))}function kt(n,t){return Mt(n,t,h,d,"int")}function Rt(n,t){return Mt(n,t,m,y,"long")}function St(n,t){var r=kn(n,t);if(null==r)return null;if(r instanceof Date)return r.getTime();var e=Number(r);if(!isNaN(e)&&e.toString()===r.toString())return e;throw new Nt("cannot convert '".concat(r,"' to double/decimal"))}var jt=St;function Ut(n,t){var r=kn(n,t);if(r instanceof Date)return r;if(null==r)return null;var e=new Date(r),u=e.getTime();if(!isNaN(u))return e;throw new Nt("cannot convert '".concat(r,"' to date"))}var Lt=["input","to","onError","onNull"];var Ct=[192,224,240];function It(n){if(n<128)return[n];for(var t=(n<2048?1:n<65536&&2)||3,r=[(n>>6*t)+Ct[t-1]];0<t;)r.push(128|n>>6*--t&63);return r}function Dt(n,t){var r=kn(n,t),e=r[0],u=r[1],o=r[2];return!w(e)||u<0?"":o<0?e.substr(u):e.substr(u,o)}var Pt=[0,32,9,10,11,12,13,160,5760,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202];function Bt(n,t,r){var e=kn(n,t)||{},u=e.input;if(L(u))return null;for(var o=L(e.chars)?Pt:e.chars.split("").map(function(n){return n.codePointAt(0)}),i=0,a=u.length-1;r.left&&i<=a&&-1!==o.indexOf(u[i].codePointAt(0));)i++;for(;r.right&&i<=a&&-1!==o.indexOf(u[a].codePointAt(0));)a--;return u.substring(i,a+1)}function Ft(n,t,r){var e=kn(n,t);if(!w(e.input))return[];e.options&&(_(-1===e.options.indexOf("x"),"extended capability option 'x' not supported"),_(-1===e.options.indexOf("g"),"global option 'g' not supported"));for(var u=e.input,o=new RegExp(e.regex,e.options),i=null,a=[],s=0;i=u.match(o);){for(var c={match:i[0],idx:i.index+s,captures:[]},f=1;f<i.length;f++)c.captures.push(i[f]||null);if(a.push(c),!r.global)break;s=i.index+i[0].length,u=u.substr(s)}return a}var Gt=Object.freeze({__proto__:null,$abs:function(n,t){var r=kn(n,t);return null==r?null:Math.abs(r)},$add:function(n,t){var r=kn(n,t),e=!1,u=J(r,function(n,t){return S(t)&&(_(!e,"'$add' can only have one date value"),e=!0,t=t.getTime()),n+=t},0);return e?new Date(u):u},$ceil:function(n,t){var r=kn(n,t);return L(r)?null:(_(T(r)||isNaN(r),"$ceil expression must resolve to a number."),Math.ceil(r))},$divide:function(n,t){var r=kn(n,t);return r[0]/r[1]},$exp:function(n,t){var r=kn(n,t);return L(r)?null:(_(T(r)||isNaN(r),"$exp expression must resolve to a number."),Math.exp(r))},$floor:function(n,t){var r=kn(n,t);return L(r)?null:(_(T(r)||isNaN(r),"$floor expression must resolve to a number."),Math.floor(r))},$ln:function(n,t){var r=kn(n,t);return L(r)?null:(_(T(r)||isNaN(r),"$ln expression must resolve to a number."),Math.log(r))},$log:function(n,t){var r=kn(n,t),e="$log expression must resolve to array(2) of numbers";return _(M(r)&&2===r.length,e),r.some(L)?null:(_(r.some(isNaN)||r.every(T),e),Math.log10(r[0])/Math.log10(r[1]))},$log10:function(n,t){var r=kn(n,t);return L(r)?null:(_(T(r)||isNaN(r),"$log10 expression must resolve to a number."),Math.log10(r))},$mod:function(n,t){var r=kn(n,t);return r[0]%r[1]},$multiply:function(n,t){return J(kn(n,t),function(n,t){return n*t},1)},$pow:function(n,t){var r=kn(n,t);return _(M(r)&&2===r.length&&r.every(T),"$pow expression must resolve to array(2) of numbers"),_(!(0===r[0]&&r[1]<0),"$pow cannot raise 0 to a negative exponent"),Math.pow(r[0],r[1])},$round:function(n,t){var r=kn(n,t),e=r[0],u=r[1];return L(e)||isNaN(e)||Math.abs(e)===1/0?e:(_(T(e),"$round expression must resolve to a number."),Un(e,u,!0))},$sqrt:function(n,t){var r=kn(n,t);return L(r)?null:(_(T(r)&&0<r||isNaN(r),"$sqrt expression must resolve to non-negative number."),Math.sqrt(r))},$subtract:function(n,t){var r=kn(n,t);return r[0]-r[1]},$trunc:function(n,t){var r=kn(n,t),e=r[0],u=r[1];return L(e)||isNaN(e)||Math.abs(e)===1/0?e:(_(T(e),"$trunc expression must resolve to a number."),_(L(u)||T(u)&&-20<u&&u<100,"$trunc expression has invalid place"),Un(e,u,!1))},$nin:et,$arrayElemAt:function(n,t){var r=kn(n,t);if(_(M(r)&&2===r.length,"$arrayElemAt expression must resolve to array(2)"),r.some(L))return null;var e=r[1],u=r[0];return e<0&&Math.abs(e)<=u.length?u[(e+u.length)%u.length]:0<=e&&e<u.length?u[e]:void 0},$arrayToObject:function(n,t){var r=kn(n,t);return _(M(r),"$arrayToObject expression must resolve to an array"),J(r,function(n,t){return M(t)&&2==t.length?n[t[0]]=t[1]:(_(k(t)&&z(t,"k")&&z(t,"v"),"$arrayToObject expression is invalid."),n[t.k]=t.v),n},{})},$concatArrays:function(n,t){var r=kn(n,t);return _(M(r),"$concatArrays must resolve to an array"),r.some(L)?null:r.reduce(function(n,t){return sn(n,t)},[])},$filter:function(n,t){var r=kn(n,t.input),e=t.as,u=t.cond;return _(M(r),"$filter 'input' expression must resolve to an array"),r.filter(function(n){var t={};return t["$"+e]=n,!0===kn(t,u)})},$in:function(n,t){var r=kn(n,t),e=r[0],u=r[1];return _(M(u),"$in second argument must be an array"),u.some(Q.bind(null,e))},$indexOfArray:function(n,t){var r=kn(n,t);if(L(r))return null;var e=r[0],u=r[1];if(L(e))return null;_(M(e),"$indexOfArray expression must resolve to an array.");var o=r[2]||0,i=r[3];return L(i)&&(i=e.length),i<o?-1:(_(0<=o&&0<=i,"$indexOfArray expression is invalid"),(0<o||i<e.length)&&(e=e.slice(o,i)),e.findIndex(Q.bind(null,u))+o)},$isArray:function(n,t){return M(kn(n,t[0]))},$map:function(t,n){var r=kn(t,n.input);_(M(r),"$map 'input' expression must resolve to an array");var e=n.as,u=n.in,o="$"+e;return r.map(function(n){return t[o]=n,kn(t,u)})},$range:function(n,t){for(var r=kn(n,t),e=r[0],u=r[1],o=r[2]||1,i=[];e<u&&0<o||u<e&&o<0;)i.push(e),e+=o;return i},$reduce:function(n,t){var r=kn(n,t.input),e=kn(n,t.initialValue),u=t.in;return L(r)?null:(_(M(r),"$reduce 'input' expression must resolve to an array"),J(r,function(n,t){return kn({$value:n,$this:t},u)},e))},$reverseArray:function(n,t){var r=kn(n,t);if(L(r))return null;_(M(r),"$reverseArray expression must resolve to an array");var e=[];return sn(e,r),e.reverse(),e},$size:function(n,t){var r=kn(n,t);return M(r)?r.length:void 0},$slice:function(n,t){var r=kn(n,t);return $n(r[0],r[1],r[2])},$zip:function(n,t){var e=kn(n,t.inputs),r=t.useLongestLength||!1;_(M(e),"'inputs' expression must resolve to an array"),_(N(r),"'useLongestLength' must be a boolean"),M(t.defaults)&&_(B(r),"'useLongestLength' must be set to true to use 'defaults'");for(var u=0,o=0,i=e.length;o<i;o++){var a=e[o];if(L(a))return null;_(M(a),"'inputs' expression values must resolve to an array or null"),u=r?Math.max(u,a.length):Math.min(u||a.length,a.length)}for(var s=[],c=t.defaults||[],f=function(r){var n=e.map(function(n,t){return L(n[r])?c[t]||null:n[r]});s.push(n)},l=0;l<u;l++)f(l);return s},$and:function(n,t){var r=kn(n,t);return B(r)&&r.every(B)},$or:function(n,t){var r=kn(n,t);return B(r)&&r.some(B)},$not:function(n,t){return!kn(n,t[0])},$eq:ut,$gt:ot,$gte:it,$lt:at,$lte:st,$ne:ct,$cmp:function(n,t){var r=kn(n,t);return r[0]>r[1]?1:r[0]<r[1]?-1:0},$cond:function(n,t){var r,e,u,o="$cond: invalid arguments";u=M(t)?(_(3===t.length,o),r=t[0],e=t[1],t[2]):(_(k(t),o),r=t.if,e=t.then,t.else);var i=kn(n,r);return kn(n,i?e:u)},$switch:function(t,n){var r=n.branches.find(function(n){return kn(t,n.case)});return kn(t,r?r.then:n.default)},$ifNull:function(n,t){_(M(t)&&2===t.length,"$ifNull expression must resolve to array(2)");var r=kn(n,t);return L(r[0])?r[1]:r[0]},$type:function(n,t){var r=kn(n,t),e=A(r);switch(e){case v.BOOLEAN:return p.BOOL;case v.NUMBER:return 0<=r.toString().indexOf(".")?p.DOUBLE:d<=r&&r<=h?p.INT:p.LONG;case v.REGEXP:return p.REGEX;default:return e}},$toBool:wt,$toString:Tt,toInteger:Mt,$toInt:kt,$toLong:Rt,$toDouble:St,$toDecimal:jt,$toDate:Ut,$convert:function(t,r){var e=Object.create({});if(Lt.forEach(function(n){e[n]=kn(t,r[n])}),e.onNull=void 0===e.onNull?null:e.onNull,null===e.input||void 0===e.input)return e.onNull;try{switch(e.to){case 2:case v.STRING:return Tt(t,e.input);case 8:case v.BOOLEAN:case p.BOOL:return wt(t,e.input);case 9:case v.DATE:return Ut(t,e.input);case 1:case 19:case p.DOUBLE:case p.DECIMAL:case v.NUMBER:return St(t,e.input);case 16:case p.INT:return kt(t,e.input);case 18:case p.LONG:return Rt(t,e.input)}}catch(n){}if(void 0!==e.onError)return e.onError;throw new Nt("failed to convert ".concat(e.input," to ").concat(e.to))},$dayOfYear:function(n,t){var r=ft(n,t),e=new Date(r.getUTCFullYear(),0,0),u=r.getTime()-e.getTime();return Math.round(u/864e5)},$dayOfMonth:lt,$dayOfWeek:vt,$year:pt,$month:ht,$week:dt,$hour:gt,$minute:mt,$second:yt,$millisecond:$t,$dateToString:Ot,$dateFromString:function(t,r){var e=Object.create({});xt.forEach(function(n){e[n]=kn(t,r[n])}),e.format=e.format||"%Y-%m-%dT%H:%M:%S.%LZ",e.onNull=e.onNull||null;var n=e.dateString;if(null==n)return e.onNull;var u=e.format.split(/%[YGmdHMSLuVzZ]/);u.reverse();for(var o=e.format.match(/(%%|%Y|%G|%m|%d|%H|%M|%S|%L|%u|%V|%z|%Z)/g),i=Object.create({}),a="",s=0,c=o.length;s<c;s++){var f=o[s],l=bt[f];if(Array.isArray(l)){var v=l[0],p=l[3],h=n.match(p),d=u.pop()||"";null!==h?(i[v]=h[0].match(/^\d+$/)?parseInt(h[0]):h[0],n=n.substr(0,h.index)+n.substr(h.index+h[0].length),a+=Et(d)+p.toString().replace(/^\//,"").replace(/\/$/,"")):i[v]=null}}if(null===i.year||null===i.month||null===i.day||!e.dateString.match(new RegExp("^"+a+"$")))return e.onError;var g=_t(e.timezone),m=new Date(Date.UTC(i.year,i.month-1,i.day,g,0,0));return null!==i.hour&&m.setUTCHours(i.hour+g),null!==i.minute&&m.setUTCMinutes(i.minute),null!==i.second&&m.setUTCSeconds(i.second),null!==i.millisecond&&m.setUTCMilliseconds(i.millisecond),m},$literal:function(n,t){return t},$objectToArray:function(n,t){var r=kn(n,t);_(k(r),"$objectToArray expression must resolve to an object");var e=[];return q(r,function(n,t){return e.push({k:t,v:n})}),e},$mergeObjects:function(n,t){var r=kn(n,t);return M(r)?J(r,function(n,t){return Object.assign(n,t)},{}):{}},$setEquals:function(n,t){var r=kn(n,t),e=W(r[0]),u=W(r[1]);return e.length===u.length&&e.length===V(e,u).length},$setIntersection:function(n,t){var r=kn(n,t);return V(r[0],r[1])},$setDifference:function(n,t){var r=kn(n,t);return r[0].filter(P.bind(null,r[1]))},$setUnion:function(n,t){var r,e,u=kn(n,t);return r=u[0],e=u[1],sn(sn([],r),e.filter(P.bind(null,r)))},$setIsSubset:function(n,t){var r=kn(n,t);return V(r[0],r[1]).length===r[0].length},$anyElementTrue:function(n,t){return kn(n,t)[0].some(B)},$allElementsTrue:function(n,t){return kn(n,t)[0].every(B)},$concat:function(n,t){var r=kn(n,t);return[null,void 0].some(D.bind(null,r))?null:r.join("")},$indexOfBytes:function(n,t){var r=kn(n,t),e="$indexOfBytes expression resolves to invalid an argument";if(L(r[0]))return null;_(w(r[0])&&w(r[1]),e);var u=r[0],o=r[1],i=r[2],a=r[3],s=L(i)||T(i)&&0<=i&&Math.round(i)===i;if(_(s=s&&(L(a)||T(a)&&0<=a&&Math.round(a)===a),e),i=i||0,(a=a||u.length)<i)return-1;var c=u.substring(i,a).indexOf(o);return-1<c?c+i:c},$split:function(n,t){var r=kn(n,t);return L(r[0])?null:(_(r.every(w),"$split expression must result to array(2) of strings"),r[0].split(r[1]))},$strLenBytes:function(n,t){return~-encodeURI(kn(n,t)).split(/%..|./).length},$strLenCP:function(n,t){return kn(n,t).length},$strcasecmp:function(n,t){var r=kn(n,t),e=r[0],u=r[1];return Q(e,u)||r.every(L)?0:(_(r.every(w),"$strcasecmp must resolve to array(2) of strings"),e=e.toUpperCase(),((u=u.toUpperCase())<e?1:e<u&&-1)||0)},$substrBytes:function(n,t){var r=kn(n,t),e=r[0],u=r[1],o=r[2];_(w(e)&&T(u)&&0<=u&&T(o)&&0<=o,"$substrBytes: invalid arguments");for(var i=function(n){for(var t=[],r=0,e=n.length;r<e;r++)t.push(It(n.codePointAt(r)));return t}(e),a=[],s=0,c=0;c<i.length;c++)a.push(s),s+=i[c].length;var f=a.indexOf(u),l=a.indexOf(u+o);return _(-1<f&&-1<l,"$substrBytes: invalid range, start or end index is a UTF-8 continuation byte."),e.substring(f,l)},$substr:Dt,$substrCP:function(n,t){return Dt(n,t)},$toLower:function(n,t){var r=kn(n,t);return F(r)?"":r.toLowerCase()},$toUpper:function(n,t){var r=kn(n,t);return F(r)?"":r.toUpperCase()},$trim:function(n,t){return Bt(n,t,{left:!0,right:!0})},$ltrim:function(n,t){return Bt(n,t,{left:!0,right:!1})},$rtrim:function(n,t){return Bt(n,t,{left:!1,right:!0})},$regexFind:function(n,t){var r=Ft(n,t,{global:!1});return 0===r.length?null:r[0]},$regexFindAll:function(n,t){return Ft(n,t,{global:!0})},$regexMatch:function(n,t){return 0!=Ft(n,t,{global:!1}).length},$let:function(r,n){var e=n.vars,t=n.in;return Object.keys(e).forEach(function(n){var t=kn(r,e[n]);r["$"+n]=t}),kn(r,t)}});function zt(n,u,t){var o=Y(u);return 0===o.length?n:n.map(function(r){var e=O(r);return q(o,function(n){var t=kn(r,u[n]);void 0!==t?dn(e,n,t):gn(e,n)}),e})}var Yt=zt;function qt(n,o,t){var i=Tn(),r=o[i];return n.transform(function(n){var e=un(n,function(n){return kn(n,r,r)});delete(o=E(o))[i];var u=-1,t=e.keys.length;return function(){if(++u===t)return{done:!0};var n=e.keys[u],r={};return void 0!==n&&(r[i]=n),q(o,function(n,t){r[t]=Mn(e.groups[u],t,n)}),{value:r,done:!1}}})}function Xt(n){var r=Tn(),e=[!1,!1];q(n,function(n,t){t!==r&&(0===n||!1===n?e[0]=!0:1!==n&&!0!==n||(e[1]=!0),_(!(e[0]&&e[1]),"Projection cannot have a mix of inclusion and exclusion."))})}function Ht(n,o,t){if(F(o)||!k(o))return n;t=t||Object.create({});var i=rn,r=t.collation;return k(r)&&w(r.locale)&&(i=function(n){var t={sensitivity:Jt[n.strength||3],caseFirst:"off"!==n.caseFirst&&n.caseFirst||"false",numeric:n.numericOrdering||!1,ignorePunctuation:"shifted"===n.alternate};!0===(n.caseLevel||!1)&&("base"===t.sensitivity&&(t.sensitivity="case"),"accent"===t.sensitivity&&(t.sensitivity="variant"));var e=new Intl.Collator(n.locale,t);return function(n,t){if(!w(n)||!w(t))return rn(n,t);var r=e.compare(n,t);return r<0?-1:0<r?1:0}}(r)),n.transform(function(u){return q(Y(o).reverse(),function(t){var r=un(u,function(n){return ln(n,t)}),e={},n=en(r.keys,function(n,t){return e[n]=t,n},i);-1===o[t]&&n.reverse(),u=[],q(n,function(n){return sn(u,r.groups[e[n]])})}),u})}var Jt={1:"base",2:"accent",3:"variant"};var Vt=Object.freeze({__proto__:null,$addFields:zt,$set:Yt,$bucket:function(n,u,t){var o=u.boundaries,i=u.default,a=o[0],s=o[o.length-1],r=u.output||{count:{$sum:1}};_(2<o.length,"$bucket 'boundaries' expression must have at least 3 elements");for(var e=x(a),c=0,f=o.length-1;c<f;c++)_(e===x(o[c+1]),"$bucket 'boundaries' must all be of the same type"),_(o[c]<o[c+1],"$bucket 'boundaries' must be sorted in ascending order");L(i)||x(u.default)!==x(a)||_(a>u.default||s<u.default,"$bucket 'default' expression must be out of boundaries range");var l={};q(o,function(n){return l[n]=[]}),L(i)||(l[i]=[]);var v=!1;return Ln(function(){return v instanceof Bn||(n.each(function(n){var t=kn(n,u.groupBy);if(L(t)||t<a||s<=t)_(!L(i),"$bucket require a default for out of range values"),l[i].push(n);else{_(a<=t&&t<s,"$bucket 'groupBy' expression must resolve to a value in range of boundaries");var r=function(n,t){for(var r=0,e=n.length-1;r<=e;){var u=Math.round(r+(e-r)/2);if(t<n[u])e=u-1;else{if(!(t>n[u]))return u;r=u+1}}return r}(o,t),e=o[Math.max(0,r-1)];l[e].push(n)}}),o.pop(),L(i)||o.push(i),v=Ln(o).map(function(n){var t=Mn(l[n],null,r);return Object.assign(t,{_id:n})})),v.next()})},$bucketAuto:function(n,t,r){var d=t.output||{count:{$sum:1}},g=t.groupBy,m=t.buckets;return _(0<m,"The $bucketAuto 'buckets' field must be greater than 0, but found: "+m),n.transform(function(n){for(var t=Math.max(1,Math.round(n.length/m)),r=cn(kn),e={},u=[],o=en(n,function(n){var t=r(n,g);return L(t)?u.push(n):(e[t]||(e[t]=[]),e[t].push(n)),t}),i=Tn(),a=[],s=0,c=0,f=o.length;c<m&&s<f;c++){for(var l=Object.create({min:0,max:0}),v=new Array,p=0;p<t&&s<f;p++){var h=r(o[s],g);if(L(h)&&(h=null),sn(v,L(h)?u:e[h]),s+=L(h)?u.length:e[h].length,z(l,"min")||(l.min=h),0<a.length)a[a.length-1][i].max=l.min}c==m-1&&sn(v,o.slice(s)),a.push(Object.assign(Mn(v,null,d),{_id:l}))}return 0<a.length&&(a[a.length-1][i].max=r(o[o.length-1],g)),a})},$count:function(t,r,n){return _(w(r)&&""!==r.trim()&&-1===r.indexOf(".")&&"$"!==r.trim()[0],"Invalid expression value for $count"),Ln(function(){var n={};return n[r]=t.size(),{value:n,done:!1}}).first()},$facet:function(n,r,t){return n.transform(function(t){return[X(r,function(n){return Gn(t,n)})]})},$group:qt,$limit:function(n,t,r){return n.take(t)},$lookup:function(n,t,r){var e=t.from,u=t.localField,o=t.foreignField,i=t.as;_(M(e)&&w(o)&&w(u)&&w(i),"$lookup: invalid argument");var a={};return q(e,function(n){var t=tn(ln(n,o));a[t]=a[t]||[],a[t].push(n)}),n.map(function(n){var t=tn(ln(n,u)),r=E(n);return r[i]=a[t]||[],r})},$match:function(n,t,r){var e=new Yn(t);return n.filter(function(n){return e.test(n)})},$out:function(n,t,r){return _(M(t),"$out expression must be an array"),n.map(function(n){return t.push(n),n})},$project:function(n,t,r){if(F(t))return n;var e=Y(t),u=!1,o=Tn();if(Xt(t),D(e,o)){var i=t[o];0!==i&&!1!==i||(e=e.filter(P.bind(null,[o])),_(P(e,o),"Must not contain collections id key"),u=F(e))}else e.push(o);return n.map(function(n){return function s(c,f,n,t){var l=Tn();var v=new Object;var p=!1;var h=!1;var d=[];t&&d.push(l);n.forEach(function(n){var t=void 0,r=f[n];if(n!==l&&D([0,!1],r)&&(h=!0),n===l&&F(r))t=c[n];else if(w(r))t=kn(c,r,n);else if(!D([1,!0],r))if(Array.isArray(r))t=r.map(function(n){var t=kn(c,n);return L(t)?null:t});else{if(!k(r))return void d.push(n);var e=Y(r),u=1==e.length?e[0]:null,o=xn(g.OperatorType.PROJECTION,u);if(o)"$slice"===u?G(r[u]).every(T)?(t=o(c,r[u],n),p=!0):t=kn(c,r,n):t=o(c,r[u],n);else if(mn(u))t=kn(c,r[u],u);else if(z(c,n)){Xt(r);var i=c[n];t=Array.isArray(i)?i.map(function(n){return s(n,r,e,!1)}):(i=k(i)?i:c,s(i,r,e,!1))}else t=kn(c,r)}var a=vn(c,n,{preserveMissing:!0});void 0!==a&&H(v,a,{flatten:!0}),P([0,1,!1,!0],r)&&(void 0===t?gn(v,n):dn(v,n,t))});pn(v);(p||h||t)&&(v=Object.assign({},c,v),0<d.length&&(v=O(v),q(d,function(n){return gn(v,n)})));return v}(n,t,e,u)})},$redact:function(n,t,r){return n.map(function(n){return Rn(O(n),t)})},$replaceRoot:function(n,t,r){return n.map(function(n){return _(k(n=kn(n,t.newRoot)),"$replaceRoot expression must return an object"),n})},$sample:function(n,t,r){var u=t.size;return _(T(u),"$sample size must be a positive integer"),n.transform(function(t){var r=t.length,e=-1;return function(){if(++e===u)return{done:!0};var n=Math.floor(Math.random()*r);return{value:t[n],done:!1}}})},$skip:function(n,t,r){return n.drop(t)},$sort:Ht,$sortByCount:function(n,t,r){var e={count:{$sum:1}};return e[Tn()]=t,Ht(qt(n,e),{count:-1},r)},$unwind:function(u,n,t){function o(n,t){return!1!==r&&(n[r]=t),n}w(n)&&(n={path:n});var i,a=n.path.substr(1),r=n.includeArrayIndex||!1,s=n.preserveNullAndEmptyArrays||!1;return Ln(function(){for(var n=function(){if(i instanceof Bn){var n=i.next();if(!n.done)return{v:n}}var e=u.next();if(e.done)return{v:e};if(e=e.value,i=ln(e,a),M(i)){if(0===i.length&&!0===s){i=null;var t=O(e);return gn(t,a),{v:{value:o(t,null),done:!1}}}i=Ln(i).map(function(n,t){var r=O(e);return dn(r,a,n),o(r,t)})}else if(!F(i)||!0===s){var r=O(e);return{v:{value:o(r,null),done:!1}}}};;){var t=n();if("object"===c(t))return t.v}})}}),Zt=qn(function(n,t){var r=!1;if(M(n)&&M(t))for(var e=0,u=t.length;e<u;e++){if(!k(t[e])||!D(Y(t[e]),"$elemMatch"))return V(t,n).length===u;r=r||tt(n,t[e].$elemMatch)}return r}),Kt=qn(tt),Qt=qn(function(n,t){return n.length===t});var Wt=qn(Hn),nr=qn(Wn),tr=qn(nt),rr=qn(Vn),er=qn(Kn),ur=qn(Qn),or=qn(Jn),ir=qn(Zn),ar=qn(function(n,t){return(!1===t||0===t)&&void 0===n||(!0===t||1===t)&&void 0!==n}),sr=qn(function(n,t){switch(t){case 1:case 19:case p.DOUBLE:case p.DECIMAL:return T(n);case 2:case v.STRING:return w(n);case 3:case v.OBJECT:return k(n);case 4:case v.ARRAY:return M(n);case 6:case v.UNDEFINED:return L(n);case 8:case v.BOOLEAN:case p.BOOL:return N(n);case 9:case v.DATE:return S(n);case 10:case v.NULL:return C(n);case 11:case v.REGEXP:case p.REGEX:return j(n);case 16:case p.INT:return T(n)&&d<=n&&n<=h&&-1===n.toString().indexOf(".");case 18:case p.LONG:return T(n)&&y<=n&&n<=m&&-1===n.toString().indexOf(".");default:return!1}}),cr=qn(function(n,t){return G(n).some(function(n){return 2===t.length&&n%t[0]===t[1]})}),fr=qn(function(n,t){function r(n){return w(n)&&!!n.match(t)}return(n=G(n)).some(r)||Z(n,1).some(r)});function lr(n,t){_(M(t),"Invalid expression. $or expects value to be an Array");var r=[];return t.forEach(function(n){return r.push(new Yn(n))}),function(n){for(var t=0;t<r.length;t++)if(r[t].test(n))return!0;return!1}}var vr=Object.freeze({__proto__:null,$all:Zt,$elemMatch:Kt,$size:Qt,$bitsAllClear:function(n,t){throw new Error("$bitsAllClear not implemented")},$bitsAllSet:function(n,t){throw new Error("$bitsAllSet not implemented")},$bitsAnyClear:function(n,t){throw new Error("$bitsAnyClear not implemented")},$bitsAnySet:function(n,t){throw new Error("$bitsAllClear not implemented")},$eq:Wt,$gt:nr,$gte:tr,$in:rr,$lt:er,$lte:ur,$ne:or,$nin:ir,$exists:ar,$type:sr,$mod:cr,$regex:fr,$jsonSchema:function(n,t){throw new Error("$jsonSchema not implemented")},$where:function(n,t){var r;return r=U(t)?t:new Function("return "+t+";"),function(n){return!0===r.call(n)}},$expr:function(n,t){return function(n){return kn(n,t)}},$and:function(n,t){_(M(t),"Invalid expression: $and expects value to be an Array");var r=[];return t.forEach(function(n){return r.push(new Yn(n))}),function(n){for(var t=0;t<r.length;t++)if(!r[t].test(n))return!1;return!0}},$or:lr,$nor:function(n,t){_(M(t),"Invalid expression. $nor expects value to be an Array");var r=lr(0,t);return function(n){return!r(n)}},$not:function(n,t){var r={};r[n]=yn(t);var e=new Yn(r);return function(n){return!e.test(n)}}});var pr=Object.freeze({__proto__:null,$:function(n,t,r){throw new Error("$ not implemented")},$elemMatch:function(n,t,r){var e=ln(n,r),u=new Yn(t);_(Array.isArray(e),"$elemMatch: invalid argument");for(var o=0;o<e.length;o++)if(u.test(e[o]))return[e[o]]},$slice:function(n,t,r){var e=ln(n,r);return Array.isArray(e)?Array.isArray(t)?$n(e,t[0],t[1]):(_(T(t),"$slice: invalid arguments for projection"),$n(e,t)):e}});function hr(){En(g.OperatorType.ACCUMULATOR,jn),En(g.OperatorType.EXPRESSION,Gt),En(g.OperatorType.PIPELINE,Vt),En(g.OperatorType.PROJECTION,pr),En(g.OperatorType.QUERY,vr)}hr(),g.Aggregator=Fn,g.Cursor=zn,g.Lazy=Ln,g.Query=Yn,g.addOperators=function(r,n){var o=n(function(){return Object.assign({computeValue:kn},_n())}());q(o,function(n,t){_(/^\$[a-zA-Z0-9_]*$/.test(t),"Invalid operator name ".concat(t)),_(!xn(r,t),"".concat(t," already exists for '").concat(r,"' operators"))});var t={};switch(r){case g.OperatorType.QUERY:q(o,function(u,n){u=u.bind(o),t[n]=function(r,e){return function(n){var t=ln(n,r,{preserveMetadata:!0});return t=K(t.result,t.depth),u(r,t,e)}}});break;case g.OperatorType.PROJECTION:q(o,function(u,n){u=u.bind(o),t[n]=function(n,t,r){var e=ln(n,r);return u(r,e,t)}});break;default:q(o,function(e,n){t[n]=function(){for(var n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];return e.apply(o,t)}})}En(r,t)},g.aggregate=Gn,g.enableSystemOperators=hr,g.find=function(n,t,r){return new Yn(t).find(n,r)},g.remove=function(n,t){return new Yn(t).remove(n)},g.setup=function(n){Object.assign(An,n)},g.useOperators=En,Object.defineProperty(g,"__esModule",{value:!0})});