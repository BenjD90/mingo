"use strict";function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function n(n,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};!function(n,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.mingo=n.mingo||{})}(void 0,function(n){function t(n,t){_(n)&&k(t)}function e(n){switch(u(n)){case"array":return n.map(e);case"object":return A(n,e);default:return n}}function r(n){return null===n?"Null":void 0===n?"Undefined":n.constructor.name}function u(n){return r(n).toLowerCase()}function i(n){return"boolean"===u(n)}function o(n){return"string"===u(n)}function a(n){return"number"===u(n)}function l(n){return"array"===u(n)}function s(n){return"object"===u(n)}function c(n){return n===Object(n)}function f(n){return"date"===u(n)}function v(n){return"regexp"===u(n)}function h(n){return"function"===u(n)}function d(n){return p(n)||g(n)}function p(n){return"null"===u(n)}function g(n){return"undefined"===u(n)}function $(n,t){return n.includes(t)}function m(n,t){return!n.includes(t)}function y(n){return!!n}function _(n){return!n}function b(n){return d(n)||l(n)&&0===n.length||s(n)&&0===N(n).length||!n}function x(n){return l(n)?n:[n]}function O(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function k(n){throw new Error(n)}function N(n){return Object.keys(n)}function w(n,t){n.__mingo__=Object.assign(n.__mingo__||{},t)}function j(n,t){return O(n,"__mingo__")&&s(t)&&E(Object.assign({},n.__mingo__,t),n.__mingo__)}function M(n){O(n,"__mingo__")&&delete n.__mingo__}function C(n,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t(n===Object(n),"Cannot iterate over object of type '"+u(n)+"'");var i=!1,o=function(){i=!0,k("halt")};if(l(n))for(var a=0,s=n.length;s>a;a++)try{e.call(r,n[a],a,n,o)}catch(c){return void t(i,c.message)}else for(var f in n)if(O(n,f))try{e.call(r,n[f],f,n,o)}catch(c){return void t(i,c.message)}}function A(n,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(l(n))return n.map(t,e);if(s(n)){for(var r,u={},i=N(n),o=0,a=i.length;a>o;o++)r=i[o],u[r]=t.call(e,n[r],r);return u}k("Input must be an Array or Object type")}function I(n,t){return n.filter($.bind(null,t))}function S(n,t){var e=[];return U(e,n),U(e,t.filter(m.bind(null,n))),e}function E(n,t){if(n===t)return!0;var e=u(n);if(e!==u(t))return!1;if("number"===e&&isNaN(n)&&isNaN(t))return!0;if($(["date","regexp"],e))return n.toString()===t.toString();if("array"===e){if(n.length===t.length&&0===n.length)return!0;if(n.length!==t.length)return!1;for(var r=0,i=n.length;i>r;r++)if(!E(n[r],t[r]))return!1}else{if(![n,t].every(s))return!1;var o=N(n),a=N(t);if(o.length!==a.length)return!1;if(o.sort(),a.sort(),!E(o,a))return!1;for(var l=0,c=o.length;c>l;l++){var f=o[l];if(!E(n[f],t[f]))return!1}}return!0}function q(n){var t={},e=[];return C(n,function(n){var r=D(n);O(t,r)||(e.push(n),t[r]=0)}),e}function P(n){return JSON.stringify({"":n})+u(n)+n}function D(n){var t=0,e=void 0,r=void 0,u=void 0,i=P(n);if(0===i.length)return t;for(e=0,u=i.length;u>e;e++)r=i.charCodeAt(e),t=(t<<5)-t+r,t|=0;return t.toString()}function R(n,e){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,u={},i=[],o=n.length,a=[],l=0;o>l;l++){var s=n[l],c=e.call(r,s,l);if(d(c))a.push(s);else{var f=D(s);O(u,f)||(u[f]=[c,l]),i.push(s)}}return i.sort(function(n,t){var e=u[D(n)],r=u[D(t)];return e[0]<r[0]?-1:e[0]>r[0]?1:e[1]<r[1]?-1:e[1]>r[1]?1:0}),U(a,i),t(a.length===n.length,"sortBy must retain collection length"),a}function T(n,e,r){var u={keys:[],groups:[]},i={};return C(n,function(n){var t=e.call(r,n),o=D(t),a=-1;g(i[o])&&(a=u.keys.length,i[o]=a,u.keys.push(t),u.groups.push([])),a=i[o],u.groups[a].push(n)}),t(u.keys.length===u.groups.length,"Cardinality must be equal for groups and keys"),u}function U(n,t){Array.prototype.push.apply(n,t)}function F(n,t){for(var e=0,r=n.length-1;r>=e;){var u=Math.round(e+(r-e)/2);if(t<n[u])r=u-1;else{if(!(t>n[u]))return u;e=u+1}}return e}function L(n){var t=this;return function(e){return function(){for(var r=arguments.length,u=Array(r),i=0;r>i;i++)u[i]=arguments[i];var o=D(u);return O(e,o)||(e[o]=n.apply(t,u)),e[o]}}({})}function B(n,t){return new Array(Math.max(t-String(n).length+1,0)).join("0")+n}function Y(n,e){return t(l(e),"Aggregation pipeline must be an array"),new wn(e).run(n)}function J(n,e,r){if($(z(In),e))return fn[e](n,r);if(s(r)){var u={};return C(r,function(e,i,o,a){u[i]=J(n,i,r[i]),$(z(In),i)&&(u=u[i],t(1===N(r).length,"Invalid $group expression '"+JSON.stringify(r)+"'"),a())}),u}}function z(n){return N(Cn[n])}function G(n,e){var r=e(ln());t(O(Cn,n),"Could not identify operator class '"+n+"'");var u=Cn[n];C(r,function(e,r){t(/^\$\w+$/.test(r),"Invalid operator name '"+r+"'"),t(!O(u,r),"Operator "+r+" is already defined for "+n+" operators")});var o={};switch(n){case qn:C(r,function(n,t){o[t]=function(n,e){return function(r,u){return{test:function(o){var a=V(o,r),l=n.call(e,r,a,u);return i(l)?l:l instanceof Bn?l.test(o):void k("Invalid return type for '"+t+"'. Must return a Boolean or Query")}}}}(n,r)});break;case En:C(r,function(n,t){o[t]=function(n,t){return function(e,r,u){var i=V(e,u);return n.call(t,u,i,r)}}(n,r)});break;default:C(r,function(n,t){o[t]=function(n,t){return function(){for(var e=arguments.length,r=Array(e),u=0;e>u;u++)r[u]=arguments[u];return n.apply(t,r)}}(n,r)})}Object.assign(Cn[n],o)}function H(){return Pn.key}function Q(n,t){return n[t]}function V(n,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,r=t.split("."),u=n,i=function(n){var t=null===r[n].match(/^\d+$/);if(t&&l(u)){if(e===!0&&0===n)return{v:u};u=u.map(function(t){return V(t,r[n],!0)}),w(u,{isMulti:!0}),1===u.length&&(u=u[0])}else u=Q(u,r[n]),e=!1;return d(u)?"break":void 0};n:for(var o=0;o<r.length;o++){var a=i(o);switch(a){case"break":break n;default:if("object"===("undefined"==typeof a?"undefined":_typeof(a)))return a.v}}return u}function K(n,e){if(!d(n)){var r=e.split("."),u=r[0],i=1===r.length||r.slice(1).join("."),o=null!==u.match(/^\d+$/),a=r.length>1,s=void 0,c=void 0;try{l(n)?o?(s=Q(n,u),a&&(s=K(s,i)),t(!g(s)),s=[s]):(s=[],C(n,function(n){c=K(n,e),d(c)||s.push(c)}),t(s.length>0)):(c=Q(n,u),a&&(c=K(c,i)),t(!g(c)),s={},s[u]=c)}catch(f){s=void 0}return s}}function W(n,t,e){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1,u=t.split("."),i=u[0],o=1===u.length||u.slice(1).join(".");if(1===u.length)e(n,i);else if(l(n)&&!/^\d+$/.test(i))C(n,function(n){W(n,t,e,r)});else{if(r===!0){var a=O(n,i);a&&!d(n[i])||(n[i]={})}W(n[i],o,e,r)}}function X(n,t,e){W(n,t,function(n,t){n[t]=e},!0)}function Z(n,t){W(n,t,function(n,t){l(n)&&/^\d+$/.test(t)?n.splice(parseInt(t),1):s(n)&&delete n[t]})}function nn(n){for(var t=0;t<Fn.length;t++)if(Fn[t](n))return!0;return!1}function tn(n){return nn(n)||!c(n)}function en(n){if(tn(n))return v(n)?{$regex:n}:{$eq:n};if(c(n)){var t=N(n),e=0===I(z(qn),t).length;if(e)return{$eq:n};if($(t,"$regex")){var r=n.$regex,u=n.$options||"",i="";o(r)&&(i+=r.ignoreCase||u.indexOf("i")>=0?"i":"",i+=r.multiline||u.indexOf("m")>=0?"m":"",i+=r.global||u.indexOf("g")>=0?"g":"",r=new RegExp(r,i)),n.$regex=r,delete n.$options}}return n}function rn(n,e,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(i=i||{},i.root=i.root||n,$(z(An),r))return Nn[r](n,e,i);if($(z(In),r))return n=rn(n,e,null,i),t(l(n),r+" expression must resolve to an array"),fn[r](n,null,i);if(o(e)&&e.length>0&&"$"===e[0]){if($(Tn,e))return Dn[e](n,null,i);if($(Un,e))return e;var a=Tn.filter(function(n){return 0===e.indexOf(n+".")});return 1===a.length&&(a=a[0],"$$ROOT"===a&&(n=i.root),e=e.substr(a.length)),V(n,e.slice(1))}switch(u(e)){case"array":return e.map(function(t){return rn(n,t,null)});case"object":var s={};return C(e,function(r,u,o,a){s[u]=rn(n,r,u,i),$(z(An),u)&&(t(1===N(e).length,"Invalid aggregation expression '"+JSON.stringify(e)+"'"),s=s[u],a())}),s;default:return e}}function un(n,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return d(r)?0>e?(e=Math.max(0,n.length+e),r=n.length-e+1):(r=e,e=0):(0>e&&(e=Math.max(0,n.length+e)),t(r>0,"Invalid argument value for $slice operator. Limit must be a positive number"),r+=e),Array.prototype.slice.apply(n,[e,r])}function on(n){var t=n.data.reduce(function(n,t){return n+t},0),e=n.data.length||1,r=n.sampled===!0?1:0,u=t/(e-r);return Math.sqrt(n.data.reduce(function(n,t){return n+Math.pow(t-u,2)},0)/e)}function an(n,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e=e||{},e.root=e.root||n;var r=rn(n,t,null,e);return $(Un,r)?Rn[r](n,t,e):r}function ln(){return{computeValue:rn,idKey:H,ops:z,resolve:V,assert:t,clone:e,each:C,err:k,getType:r,has:O,isArray:l,isBoolean:i,isDate:f,isEmpty:b,isEqual:E,isFunction:h,isNil:d,isNull:p,isNumber:a,isObject:s,isRegExp:v,isString:o,isUndefined:g,keys:N}}function sn(n,t,e){return new Bn(t).find(n,e)}function cn(n,t){return new Bn(t).remove(n)}var fn={$addToSet:function(n,t){return q(this.$push(n,t))},$sum:function(n,t){return l(n)?a(t)?n.length*t:this.$push(n,t).filter(a).reduce(function(n,t){return n+t},0):0},$max:function(n,t){var e=this.$push(n,t);return e.reduce(function(n,t){return d(n)||t>n?t:n},void 0)},$min:function(n,t){var e=this.$push(n,t);return e.reduce(function(n,t){return d(n)||n>t?t:n},void 0)},$avg:function(n,t){var e=this.$push(n,t).filter(a),r=e.reduce(function(n,t){return n+t},0);return r/(e.length||1)},$push:function(n,t){return d(t)?n:n.map(function(n){return rn(n,t,null)})},$first:function(n,t){return n.length>0?rn(n[0],t):void 0},$last:function(n,t){return n.length>0?rn(n[n.length-1],t):void 0},$stdDevPop:function(n,t){var e=this.$push(n,t).filter(a);return on({data:e,sampled:!1})},$stdDevSamp:function(n,t){var e=this.$push(n,t).filter(a);return on({data:e,sampled:!0})}},vn={$abs:function(n,t){var e=rn(n,t,null);return null===e||void 0===e?null:Math.abs(e)},$add:function(n,t){var e=rn(n,t,null);return e.reduce(function(n,t){return n+t},0)},$ceil:function(n,e){var r=rn(n,e,null);return isNaN(r)?NaN:d(r)?null:(t(a(r),"$ceil must be a valid expression that resolves to a number."),Math.ceil(r))},$divide:function(n,t){var e=rn(n,t,null);return e[0]/e[1]},$exp:function(n,e){var r=rn(n,e,null);return isNaN(r)?NaN:d(r)?null:(t(a(r),"$exp must be a valid expression that resolves to a number."),Math.exp(r))},$floor:function(n,e){var r=rn(n,e,null);return isNaN(r)?NaN:d(r)?null:(t(a(r),"$floor must be a valid expression that resolves to a number."),Math.floor(r))},$ln:function(n,e){var r=rn(n,e,null);return isNaN(r)?NaN:d(r)?null:(t(a(r),"$ln must be a valid expression that resolves to a number."),Math.log(r))},$log:function(n,e){var r=rn(n,e,null);return t(l(r)&&2===r.length,"$log must be a valid expression that resolves to an array of 2 items"),r.some(isNaN)?NaN:r.some(d)?null:(t(r.every(a),"$log expression must resolve to array of 2 numbers"),Math.log10(r[0])/Math.log10(r[1]))},$log10:function(n,e){var r=rn(n,e,null);return isNaN(r)?NaN:d(r)?null:(t(a(r),"$log10 must be a valid expression that resolves to a number."),Math.log10(r))},$mod:function(n,t){var e=rn(n,t,null);return e[0]%e[1]},$multiply:function(n,t){var e=rn(n,t,null);return e.reduce(function(n,t){return n*t},1)},$pow:function(n,e){var r=rn(n,e,null);return t(l(r)&&2===r.length&&r.every(a),"$pow must be a valid expression that resolves to an array of 2 numbers"),t(!(0===r[0]&&r[1]<0),"$pow cannot raise 0 to a negative exponent"),Math.pow(r[0],r[1])},$sqrt:function(n,e){var r=rn(n,e,null);return isNaN(r)?NaN:d(r)?null:(t(a(r)&&r>0,"$sqrt must be a valid expression that resolves to a non-negative number."),Math.sqrt(r))},$subtract:function(n,t){var e=rn(n,t,null);return e[0]-e[1]},$trunc:function(n,e){var r=rn(n,e,null);return isNaN(r)?NaN:d(r)?null:(t(a(r)&&r>0,"$trunc must be a valid expression that resolves to a non-negative number."),Math.trunc(r))}},hn={$arrayElemAt:function(n,e){var r=rn(n,e,null);t(l(r)&&2===r.length,"$arrayElemAt expression must resolve to an array of 2 elements"),t(l(r[0]),"First operand to $arrayElemAt must resolve to an array"),t(a(r[1]),"Second operand to $arrayElemAt must resolve to an integer");var u=r[1];return r=r[0],0>u&&Math.abs(u)<=r.length?r[u+r.length]:u>=0&&u<r.length?r[u]:void 0},$concatArrays:function(n,e){var r=rn(n,e,null);return t(l(r)&&2===r.length,"$concatArrays expression must resolve to an array of 2 elements"),r.some(d)?null:r[0].concat(r[1])},$filter:function(n,e){var r=rn(n,e.input,null),u=e.as,i=e.cond;return t(l(r),"'input' expression for $filter must resolve to an array"),r.filter(function(n){var t={};return t["$"+u]=n,rn(t,i,null)===!0})},$indexOfArray:function(n,e){var r=rn(n,e,null);if(d(r))return null;var u=r[0];if(d(u))return null;t(l(u),"First operand for $indexOfArray must resolve to an array.");var i=r[1];if(d(i))return null;var o=r[2]||0,a=r[3]||u.length;return a<u.length&&(u=u.slice(o,a)),u.indexOf(i,o)},$isArray:function(n,t){return l(rn(n,t,null))},$range:function(n,t){for(var e=rn(n,t,null),r=e[0],u=e[1],i=e[2]||1,o=[];u>r&&i>0||r>u&&0>i;)o.push(r),r+=i;return o},$reverseArray:function(n,e){var r=rn(n,e,null);if(d(r))return null;t(l(r),"$reverseArray expression must resolve to an array");for(var u=[],i=r.length-1;i>-1;i--)u.push(r[i]);return u},$reduce:function(n,e){var r=rn(n,e.input,null),u=rn(n,e.initialValue,null),i=e["in"];return d(r)?null:(t(l(r),"'input' expression for $reduce must resolve to an array"),r.reduce(function(n,t){return rn({$value:n,$this:t},i,null)},u))},$size:function(n,t){var e=rn(n,t,null);return l(e)?e.length:void 0},$slice:function(n,t){var e=rn(n,t,null);return un(e[0],e[1],e[2])},$zip:function(n,e){var r=rn(n,e.inputs,null),u=e.useLongestLength||!1;t(l(r),"'inputs' expression must resolve to an array"),t(i(u),"'useLongestLength' must be a boolean"),l(e.defaults)&&t(y(u),"'useLongestLength' must be set to true to use 'defaults'");for(var o=0,a=0,s=r.length;s>a;a++){var c=r[a];if(d(c))return null;t(l(c),"'inputs' expression values must resolve to an array or null"),o=u?Math.max(o,c.length):Math.min(o||c.length,c.length)}for(var f=[],v=e.defaults||[],h=function(n){var t=r.map(function(t,e){return d(t[n])?v[e]||null:t[n]});f.push(t)},p=0;o>p;p++)h(p);return f}},dn={$and:function(n,t){var e=rn(n,t,null);return y(e)&&e.every(y)},$or:function(n,t){var e=rn(n,t,null);return y(e)&&e.some(y)},$not:function(n,t){return!rn(n,t[0],null)}},pn={$eq:function(n,t){if(E(n,t))return!0;if(l(n)){if(!j(n,{isMulti:!0}))return-1!==n.findIndex(E.bind(null,t));try{for(var e=0;e<n.length;e++)if(this.$eq(n[e],t))return!0}finally{M(n)}}return!1},$ne:function(n,t){return!this.$eq(n,t)},$in:function(n,t){return n=x(n),I(n,t).length>0},$nin:function(n,t){return d(n)||!this.$in(n,t)},$lt:function(n,t){return n=x(n).find(function(n){return t>n}),void 0!==n},$lte:function(n,t){return n=x(n).find(function(n){return t>=n}),void 0!==n},$gt:function(n,t){return n=x(n).find(function(n){return n>t}),void 0!==n},$gte:function(n,t){return n=x(n).find(function(n){return n>=t}),void 0!==n},$mod:function(n,t){return n=x(n).find(function(n){return a(n)&&l(t)&&2===t.length&&n%t[0]===t[1]}),void 0!==n},$regex:function(n,t){return n=x(n).find(function(n){return o(n)&&v(t)&&!!n.match(t)}),void 0!==n},$exists:function(n,t){return(t===!1||0===t)&&d(n)||(t===!0||1===t)&&!d(n)},$all:function(n,t){var e=!1;if(l(n)&&l(t))for(var r=0,u=t.length;u>r;r++){if(!s(t[r])||!$(N(t[r]),"$elemMatch"))return I(t,n).length===u;e=e||this.$elemMatch(n,t[r].$elemMatch)}return e},$size:function(n,t){return l(n)&&a(t)&&n.length===t},$elemMatch:function(n,t){if(l(n)&&!b(n))for(var e=new Bn(t),r=0,u=n.length;u>r;r++)if(e.test(n[r]))return!0;return!1},$type:function(n,t){switch(t){case 1:case"double":return a(n)&&-1!==(n+"").indexOf(".");case 2:case"string":case 5:case"bindata":return o(n);case 3:case"object":return s(n);case 4:case"array":return l(n);case 6:case"undefined":return d(n);case 8:case"bool":return i(n);case 9:case"date":return f(n);case 10:case"null":return p(n);case 11:case"regex":return v(n);case 16:case"int":return a(n)&&2147483647>=n&&-1===(n+"").indexOf(".");case 18:case"long":return a(n)&&n>2147483647&&0x8000000000000000>=n&&-1===(n+"").indexOf(".");case 19:case"decimal":return a(n);default:return!1}}},gn={$and:function(n,e){t(l(e),"Invalid expression: $and expects value to be an Array");var r=[];return C(e,function(n){return r.push(new Bn(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(!r[t].test(n))return!1;return!0}}},$or:function(n,e){t(l(e),"Invalid expression. $or expects value to be an Array");var r=[];return C(e,function(n){return r.push(new Bn(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(r[t].test(n))return!0;return!1}}},$nor:function(n,e){t(l(e),"Invalid expression. $nor expects value to be an Array");var r=this.$or("$or",e);return{test:function(n){return!r.test(n)}}},$not:function(n,t){var e={};e[n]=en(t);var r=new Bn(e);return{test:function(n){return!r.test(n)}}},$where:function(n,t){return h(t)||(t=new Function("return "+t+";")),{test:function(n){return t.call(n)===!0}}}};C(pn,function(n,t){gn[t]=function(n,t){return function(e,r){return{test:function(u){var i=V(u,e);return n.call(t,i,r)}}}}(n,pn)});var $n={$cmp:function(n,t){var e=rn(n,t,null);return e[0]>e[1]?1:e[0]<e[1]?-1:0}};C(["$eq","$ne","$gt","$gte","$lt","$lte","$in","$nin"],function(n){$n[n]=function(t,e){var r=rn(t,e,null);return pn[n](r[0],r[1])}});var mn={$cond:function(n,e){var r=void 0,u=void 0,i=void 0;l(e)?(t(3===e.length,"Invalid arguments for $cond operator"),r=e[0],u=e[1],i=e[2]):s(e)&&(r=e["if"],u=e.then,i=e["else"]);var o=rn(n,r,null);return o?rn(n,u,null):rn(n,i,null)},$switch:function(n,e){t(e.branches,"Invalid arguments for $switch operator");var r=e.branches.find(function(e){return t(e["case"]&&e.then,"Invalid arguments for $switch operator"),rn(n,e["case"],null)});return r?rn(n,r.then,null):e["default"]?rn(n,e["default"],null):void k("Invalid arguments for $switch operator")},$ifNull:function(n,e){t(l(e)&&2===e.length,"Invalid arguments for $ifNull operator");var r=rn(n,e,null);return null===r[0]||void 0===r[0]?r[1]:r[0]}},yn={"%Y":["$year",4],"%m":["$month",2],"%d":["$dayOfMonth",2],"%H":["$hour",2],"%M":["$minute",2],"%S":["$second",2],"%L":["$millisecond",3],"%j":["$dayOfYear",3],"%w":["$dayOfWeek",1],"%U":["$week",2],"%%":"%"},_n={$dayOfYear:function(n,t){var e=rn(n,t,null);if(f(e)){var r=new Date(e.getFullYear(),0,0),u=e-r,i=864e5;return Math.round(u/i)}},$dayOfMonth:function(n,t){var e=rn(n,t,null);return f(e)?e.getDate():void 0},$dayOfWeek:function(n,t){var e=rn(n,t,null);return f(e)?e.getDay()+1:void 0},$year:function(n,t){var e=rn(n,t,null);return f(e)?e.getFullYear():void 0},$month:function(n,t){var e=rn(n,t,null);return f(e)?e.getMonth()+1:void 0},$week:function(n,t){var e=rn(n,t,null);e=new Date(+e),e.setHours(0,0,0),e.setDate(e.getDate()+4-(e.getDay()||7));var r=new Date(e.getFullYear(),0,1);return Math.floor(((e-r)/864e5+1)/7)},$hour:function(n,t){var e=rn(n,t,null);return f(e)?e.getUTCHours():void 0},$minute:function(n,t){var e=rn(n,t,null);return f(e)?e.getMinutes():void 0},$second:function(n,t){var e=rn(n,t,null);return f(e)?e.getSeconds():void 0},$millisecond:function(n,t){var e=rn(n,t,null);return f(e)?e.getMilliseconds():void 0},$dateToString:function(n,t){for(var e=t.format,r=rn(n,t.date,null),u=e.match(/(%%|%Y|%m|%d|%H|%M|%S|%L|%j|%w|%U)/g),i=0,o=u.length;o>i;i++){var a=yn[u[i]],s=a;if(l(a)){var c=this[a[0]],f=a[1];s=B(c.call(this,n,r),f)}e=e.replace(u[i],s)}return e}},bn={$literal:function(n,t){return t}},xn={$setEquals:function(n,t){var e=rn(n,t,null),r=q(e[0]),u=q(e[1]);return r.length===u.length&&r.length===I(r,u).length},$setIntersection:function(n,t){var e=rn(n,t,null);return I(e[0],e[1])},$setDifference:function(n,t){var e=rn(n,t,null);return e[0].filter(m.bind(null,e[1]))},$setUnion:function(n,t){var e=rn(n,t,null);return S(e[0],e[1])},$setIsSubset:function(n,t){var e=rn(n,t,null);return I(e[0],e[1]).length===e[0].length},$anyElementTrue:function(n,t){var e=rn(n,t,null)[0];return e.some(y)},$allElementsTrue:function(n,t){var e=rn(n,t,null)[0];return e.every(y)}},On={$concat:function(n,t){var e=rn(n,t,null);return[null,void 0].some($.bind(null,e))?null:e.join("")},$indexOfBytes:function(n,e){var r=rn(n,e,null);if(d(r[0]))return null;t(o(r[0]),"$indexOfBytes first operand must resolve to a string"),t(o(r[1]),"$indexOfBytes second operand must resolve to a string");var u=r[0],i=r[1],l=r[2],s=r[3];if(t(d(l)||a(l)&&l>=0&&Math.round(l)===l,"$indexOfBytes third operand must resolve to a non-negative integer"),l=l||0,t(d(s)||a(s)&&s>=0&&Math.round(s)===s,"$indexOfBytes fourth operand must resolve to a non-negative integer"),s=s||u.length,l>s)return-1;var c=u.substring(l,s).indexOf(i);return c>-1?c+l:c},$split:function(n,e){var u=rn(n,e,null);return t(o(u[0]),"$split requires an expression that evaluates to a string as a first argument, found: "+r(u[0])),t(o(u[1]),"$split requires an expression that evaluates to a string as a second argument, found: "+r(u[1])),u[0].split(u[1])},$strcasecmp:function(n,t){var e=rn(n,t,null);return e[0]=b(e[0])?"":e[0].toUpperCase(),e[1]=b(e[1])?"":e[1].toUpperCase(),e[0]>e[1]?1:e[0]<e[1]?-1:0},$substr:function(n,t){var e=rn(n,t,null);return o(e[0])?e[1]<0?"":e[2]<0?e[0].substr(e[1]):e[0].substr(e[1],e[2]):""},$toLower:function(n,t){var e=rn(n,t,null);return b(e)?"":e.toLowerCase()},$toUpper:function(n,t){var e=rn(n,t,null);return b(e)?"":e.toUpperCase()}},kn={$map:function(n,e){var r=rn(n,e.input,null);t(l(r),"Input expression for $map must resolve to an array");var u=e.as,i=e["in"],o="$"+u,a=n[o];return r.map(function(t){n[o]=t;var e=rn(n,i,null);return g(a)?delete n[o]:n[o]=a,e})},$let:function(n,t){var e=t.vars,r=t["in"],u={},i=N(e);C(i,function(t){var r=rn(n,e[t],null),i="$"+t;u[i]=n[i],n[i]=r});var o=rn(n,r,null);return C(i,function(t){var e="$"+t;g(u[e])?delete n[e]:n[e]=u[e]}),o}},Nn=Object.assign({},vn,hn,dn,$n,mn,_n,bn,xn,On,kn),wn=function(){function n(t){_classCallCheck(this,n),this.__operators=t}return _createClass(n,[{key:"run",value:function(n,t){return b(this.__operators)||C(this.__operators,function(e){var r=N(e);1===r.length&&$(z(Sn),r[0])?(r=r[0],n=t instanceof Bn?Mn[r].call(t,n,e[r]):Mn[r](n,e[r])):k("Invalid aggregation operator '"+r+"'")}),n}}]),n}(),jn={$:function(n,t,e){k("$ not implemented")},$elemMatch:function(n,t,e){var r=V(n,e),u=new Bn(t);if(!d(r)&&l(r))for(var i=0;i<r.length;i++)if(u.test(r[i]))return[r[i]]},$slice:function(n,t,e){var r=V(n,e);return l(r)?l(t)?un(r,t[0],t[1]):a(t)?un(r,t):void k("Invalid argument type for $slice projection operator"):r},$stdDevPop:function(n,t,e){return on({data:rn(n,t,e),sampled:!1})},$stdDevSamp:function(n,t,e){return on({data:rn(n,t,e),sampled:!0})}},Mn={$addFields:function(n,r){var u=N(r);return n.map(function(n){return n=e(n),C(u,function(e){var u=r[e],i=void 0;if(s(u)){var o=N(u),a=o.filter(function(n){return 0===n.indexOf("$")});b(a)||(t(1===o.length,"Can have only one root operator in $addFields"),a=a[0],u=u[a],i=rn(n,u,a))}else i=rn(n,u,null);W(n,e,function(n,t){n[t]=i},!0)}),n})},$group:function(n,t){var e=t[H()],r=T(n,function(n){return rn(n,e,e)}),u=[];return delete t[H()],C(r.keys,function(n,e){var i={};g(n)||(i[H()]=n),C(t,function(n,t){i[t]=J(r.groups[e],t,n)}),u.push(i)}),u},$lookup:function(n,r){function u(n){return D(d(n)?null:n)}var i=r.from,a=r.localField,s=r.foreignField,c=r.as,f="Invalid $lookup expression. ";t(l(i),f+"'from' must be an array"),t(o(s),f+"'foreignField' must be a string"),t(o(a),f+"'localField' must be a string"),t(o(c),f+"'as' must be a string");var v=[],h={};if(i.length<=n.length)C(i,function(n,t){var e=u(n[s]);h[e]=h[e]||[],h[e].push(t)}),C(n,function(n){var t=u(n[a]),r=h[t]||[],o=e(n);o[c]=r.map(function(n){return e(i[n])}),v.push(o)});else{C(n,function(n,t){var e=u(n[a]);h[e]=h[e]||[],h[e].push(t)});var p={};C(i,function(t){var r=u(t[s]),i=h[r]||[];C(i,function(r){var u=p[r]||e(n[r]);u[c]=u[c]||[],u[c].push(e(t)),p[r]=u})});for(var g=0,$=N(p).length;$>g;g++)v.push(p[g])}return v},$match:function(n,t){return new Bn(t).find(n).all()},$project:function(n,r){if(b(r))return n;var u=[],i=N(r),l=!1,c=H(),f=[!1,!1];if(C(r,function(n,e){e!==c&&(0===n||n===!1?f[0]=!0:f[1]=!0,t(f[0]!==f[1],"Projection cannot have a mix of inclusion and exclusion."))}),$(i,c)){var v=r[c];0!==v&&v!==!1||(i=i.filter(m.bind(null,[c])),t(m(i,c),"Must not contain collections id key"),l=b(i))}else i.push(c);return C(n,function(n){var t={},f=!1,v=!1,h=[];l&&h.push(c),C(i,function(u){var i=r[u],l=void 0;if(u!==c&&0===i&&(v=!0),u===c&&b(i))l=n[u];else if(o(i))l=rn(n,i,u);else if(1===i||i===!0);else{if(!s(i))return void h.push(u);var d=N(i);d=d.length>1?!1:d[0],$(z(En),d)?"$slice"===d?x(i[d]).every(a)?(l=jn[d](n,i[d],u),f=!0):l=rn(n,i,u):l=jn[d](n,i[d],u):l=rn(n,i,u)}var p=e(K(n,u));g(p)||Object.assign(t,p),g(l)||X(t,u,e(l))}),(f||v||l)&&(t=Object.assign(e(n),t),C(h,function(n){return Z(t,n)})),u.push(t)}),u},$limit:function(n,t){return n.slice(0,t)},$skip:function(n,t){return n.slice(t)},$unwind:function(n,r){var u=[],i=r.substr(1);return C(n,function(n){var r=Q(n,i);t(l(r),"Target field '"+i+"' is not of type Array."),C(r,function(t){var r=e(n);r[i]=t,u.push(r)})}),u},$sort:function(n,t){if(!b(t)&&s(t)){var e=N(t);C(e.reverse(),function(e){var r=T(n,function(n){return V(n,e)}),u={},i=function(n){return u[D(n)]},o=R(r.keys,function(n,t){return u[D(n)]=t,n});-1===t[e]&&o.reverse(),n=[],C(o,function(t){return U(n,r.groups[i(t)])})})}return n},$sortByCount:function(n,t){var e={count:{$sum:1}};return e[H()]=t,this.$sort(this.$group(n,e),{count:-1})},$sample:function(n,e){var r=e.size;t(a(r),"$sample size must be a positive integer");for(var u=[],i=n.length,o=0;r>o;o++){var l=Math.floor(Math.random()*i);u.push(n[l])}return u},$count:function(n,e){t(o(e)&&""!==e.trim()&&-1===e.indexOf(".")&&"$"!==e.trim()[0],"Invalid expression value for $count");var r={};return r[e]=n.length,r},$replaceRoot:function(n,e){var r=e.newRoot,u=[];return C(n,function(n){n=rn(n,r,null),t(s(n),"$replaceRoot expression must return a valid JS object"),u.push(n)}),u},$redact:function(n,t){return n.map(function(n){return an(e(n),t)})},$bucket:function(n,e){var u=e.boundaries,i=e["default"],o=u[0],a=u[u.length-1],l=e.output||{count:{$sum:1}};t(u.length>2,"$bucket 'boundaries' expression must have at least 3 elements");for(var s=r(o),c=0,f=u.length-1;f>c;c++)t(s===r(u[c+1]),"$bucket 'boundaries' must all be of the same type"),t(u[c]<u[c+1],"$bucket 'boundaries' must be sorted in ascending order");d(i)||r(e["default"])!==r(o)||t(o>e["default"]||a<e["default"],"$bucket 'default' expression must be out of boundaries range");var v={};return C(u,function(n){return v[n]=[]}),d(i)||(v[i]=[]),C(n,function(n){var r=rn(n,e.groupBy,null);if(d(r)||o>r||r>=a)t(!d(i),"$bucket require a default for out of range values"),v[i].push(n);else if(r>=o&&a>r){var l=F(u,r),s=u[Math.max(0,l-1)];v[s].push(n)}else k("$bucket 'groupBy' expression must resolve to a value in range of boundaries")}),u.pop(),d(i)||u.push(i),A(u,function(n){var t=J(v[n],null,l);return Object.assign(t,{_id:n})})},$bucketAuto:function(n,e){var r=e.output||{count:{$sum:1}},u=e.groupBy,i=(e.granularity,e.buckets);t(i>0,"The $bucketAuto 'buckets' field must be greater than 0, but found: "+i);var o=Math.round(n.length/i);1>o&&(o=1);for(var a=L(rn),l={},s=[],c=R(n,function(n){var t=a(n,u,null);return d(t)?s.push(n):(l[t]||(l[t]=[]),l[t].push(n)),t}),f=[],v=0,h=0,p=c.length;i>h&&p>v;h++){for(var g={},$=[],m=0;o>m&&p>v;m++){var y=a(c[v],u,null);if(d(y)&&(y=null),U($,d(y)?s:l[y]),v+=d(y)?s.length:l[y].length,O(g,"min")||(g.min=y),f.length>0){var _=f[f.length-1];_._id.max=g.min}}h==i-1&&U($,c.slice(v)),f.push(Object.assign(J($,null,r),{_id:g}))}return f.length>0&&(f[f.length-1]._id.max=a(c[c.length-1],u,null)),f},$facet:function(n,t){return A(t,function(t){return Y(n,t)})}},Cn={aggregate:Nn,group:fn,pipeline:Mn,projection:jn,query:gn},An="aggregate",In="group",Sn="pipeline",En="projection",qn="query",Pn={key:"_id"},Dn={$$ROOT:function(n,t,e){return e.root},$$CURRENT:function(n,t,e){return n}},Rn={$$KEEP:function(n){return n},$$PRUNE:function(){},$$DESCEND:function(n,t,e){if(!O(t,"$cond"))return n;var r=void 0;return C(n,function(u,i){c(u)&&(l(u)?(r=[],C(u,function(n){s(n)&&(n=an(n,t,e)),d(n)||r.push(n)})):r=an(u,t,e),d(r)?delete n[i]:n[i]=r)}),n}},Tn=N(Dn),Un=N(Rn),Fn=[o,i,a,f,d,v],Ln=function(){function n(t,e,r){_classCallCheck(this,n),this.__query=e,this.__collection=t,this.__projection=r||e.__projection,this.__operators={},this.__result=!1,this.__position=0}return _createClass(n,[{key:"_fetch",value:function(){var n=this;if(this.__result!==!1)return this.__result;s(this.__projection)&&Object.assign(this.__operators,{$project:this.__projection}),t(l(this.__collection),"Input collection is not of valid type. Must be an Array."),this.__result=this.__collection.filter(this.__query.test,this.__query);var e=[];if(C(["$sort","$skip","$limit","$project"],function(t){if(O(n.__operators,t)){var r={};r[t]=n.__operators[t],e.push(r)}}),e.length>0){var r=new wn(e);this.__result=r.run(this.__result,this.__query)}return this.__result}},{key:"all",value:function(){return this._fetch()}},{key:"first",value:function(){return this.count()>0?this._fetch()[0]:null}},{key:"last",value:function(){return this.count()>0?this._fetch()[this.count()-1]:null}},{key:"count",value:function(){return this._fetch().length}},{key:"skip",value:function(n){return Object.assign(this.__operators,{$skip:n}),this}},{key:"limit",value:function(n){return Object.assign(this.__operators,{$limit:n}),this}},{key:"sort",value:function(n){return Object.assign(this.__operators,{$sort:n}),this}},{key:"next",value:function(){return this.hasNext()?this._fetch()[this.__position++]:null}},{key:"hasNext",value:function(){return this.count()>this.__position}},{key:"max",value:function(n){return fn.$max(this._fetch(),n)}},{key:"min",value:function(n){return fn.$min(this._fetch(),n)}},{key:"map",value:function(n){return this._fetch().map(n)}},{key:"forEach",value:function(n){C(this._fetch(),n)}},{key:Symbol.iterator,value:function(){var n=this;return{next:function(){return n.hasNext()?{done:!1,value:n.next()}:{done:!0}}}}}]),n}(),Bn=function(){function n(t,e){_classCallCheck(this,n),this.__criteria=t,this.__projection=e,this.__compiled=[],this._compile()}return _createClass(n,[{key:"_compile",value:function(){var n=this;if(!b(this.__criteria)){t(s(this.__criteria),"Criteria must be of type Object");var e=void 0;C(this.__criteria,function(t,r){"$where"===r?e={field:r,expr:t}:$(["$and","$or","$nor"],r)?n._processOperator(r,r,t):(t=en(t),C(t,function(t,e){n._processOperator(r,e,t)})),s(e)&&n._processOperator(e.field,e.field,e.expr)})}}},{key:"_processOperator",value:function(n,t,e){$(z(qn),t)?this.__compiled.push(gn[t](n,e)):k("Invalid query operator '"+t+"' detected")}},{key:"test",value:function(n){for(var t=0,e=this.__compiled.length;e>t;t++)if(!this.__compiled[t].test(n))return!1;return!0}},{key:"find",value:function(n,t){return new Ln(n,this,t)}},{key:"remove",value:function(n){var t=this;return n.reduce(function(n,e){return t.test(e)||n.push(e),n},[])}}]),n}(),Yn={query:function(n,t){return sn(this.toJSON(),n,t)},aggregate:function(n){return Y.call(null,this.toJSON(),n)}},Jn="2.0.0";n.CollectionMixin=Yn,n.VERSION=Jn,n._internal=ln,n.addOperators=G,n.OP_AGGREGATE=An,n.OP_GROUP=In,n.OP_PIPELINE=Sn,n.OP_PROJECTION=En,n.OP_QUERY=qn,n.Aggregator=wn,n.aggregate=Y,n.Cursor=Ln,n.Query=Bn,
n.find=sn,n.remove=cn,Object.defineProperty(n,"__esModule",{value:!0})});
//# sourceMappingURL=dist/mingo.min.map